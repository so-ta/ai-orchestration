# Codex PR Review Workflow (Enhanced)
# PRãŒä½œæˆãƒ»æ›´æ–°ã•ã‚ŒãŸéš›ã«OpenAI CodexãŒã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œ
#
# æ©Ÿèƒ½:
# - æ§‹é€ åŒ–JSONå‡ºåŠ›ã«ã‚ˆã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã®è§£æ
# - pr_findingsï¼ˆPRå·®åˆ†å†…ã®æŒ‡æ‘˜ï¼‰â†’ æ­£å¼ãªPR Reviewã¨ã—ã¦æŠ•ç¨¿
# - other_findingsï¼ˆPRå·®åˆ†å¤–ã®æŒ‡æ‘˜ï¼‰â†’ Issueã¨ã—ã¦ä½œæˆ/çµ±åˆã€PRã«ã‚‚å ±å‘Š
# - ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã«å¿œã˜ãŸãƒ©ãƒ™ãƒ«è‡ªå‹•ä»˜ä¸
#
# è¨­å®šæ–¹æ³•:
# 1. ãƒªãƒã‚¸ãƒˆãƒªã® Settings > Secrets and variables > Actions ã§ OPENAI_API_KEY ã‚’è¨­å®š
# 2. PRãŒä½œæˆã•ã‚Œã‚‹ã¨è‡ªå‹•çš„ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå®Ÿè¡Œã•ã‚Œã‚‹
#
# å‚ç…§:
# - https://developers.openai.com/codex/github-action/
# - AGENTS.md: Codexç”¨ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³
#
# Updated: 2026-01-14 - ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å†èªè­˜ã®ãŸã‚ã®ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 

name: Codex PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: false
        type: number

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  codex-review:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}:${{ github.event.pull_request.base.ref }}

      - name: Generate PR diff
        id: diff
        run: |
          # PRå·®åˆ†ã‚’å–å¾—ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}

          echo "Base SHA: $BASE_SHA"
          echo "Head SHA: $HEAD_SHA"

          # å·®åˆ†ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’å–å¾—
          git diff --name-only $BASE_SHA $HEAD_SHA > changed_files.txt
          echo "Changed files:"
          cat changed_files.txt

          # å·®åˆ†ã®çµ±è¨ˆæƒ…å ±
          DIFF_STATS=$(git diff --shortstat $BASE_SHA $HEAD_SHA)
          echo "Diff stats: $DIFF_STATS"

          # å·®åˆ†ãŒç©ºã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
          if [ ! -s changed_files.txt ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected in PR diff"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT

            # å·®åˆ†ã®è©³ç´°ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆCodexãŒå‚ç…§ã§ãã‚‹ã‚ˆã†ã«ï¼‰
            git diff $BASE_SHA $HEAD_SHA > pr_diff.patch
            echo "PR diff saved to pr_diff.patch"

            # å·®åˆ†ã‚µã‚¤ã‚ºã‚’ç¢ºèª
            DIFF_SIZE=$(wc -c < pr_diff.patch)
            echo "Diff size: $DIFF_SIZE bytes"

            # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜
            CHANGED_FILES=$(cat changed_files.txt | tr '\n' ' ')
            echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "diff_stats=$DIFF_STATS" >> $GITHUB_OUTPUT
          fi

      - name: Generate dynamic prompt
        if: steps.diff.outputs.has_changes == 'true'
        id: prompt
        run: |
          # å‹•çš„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆï¼ˆå·®åˆ†æƒ…å ±ã‚’ç›´æ¥åŸ‹ã‚è¾¼ã‚€ï¼‰
          cat > dynamic_prompt.md << 'PROMPT_HEADER'
          # PR Review Task

          ## ãƒ¬ãƒ“ãƒ¥ãƒ¼æ–¹é‡

          **å³ã—ããƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚å•é¡ŒãŒã‚ã‚Œã°é æ…®ãªãæŒ‡æ‘˜ã—ã¦ãã ã•ã„ã€‚**

          ãŸã ã—ã€ä»¥ä¸‹ã®ã€Œè¦‹å½“é•ã„ãªæŒ‡æ‘˜ã€ã¯é¿ã‘ã¦ãã ã•ã„ï¼š
          - ã€Œâ—‹â—‹ã®å®Ÿè£…ãŒã‚ã‚Šã¾ã›ã‚“ã€â†’ åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒé«˜ã„
          - å­˜åœ¨ã—ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã¸ã®æŒ‡æ‘˜ â†’ ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ã‚’ç¢ºèªã—ã¦ã‹ã‚‰
          - å·®åˆ†å¤–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®æŒ‡æ‘˜ â†’ ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ã‚’ç¢ºèªã—ã¦ã‹ã‚‰

          ---

          ## ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ã®PRæƒ…å ±

          ### å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§
          PROMPT_HEADER

          echo '```' >> dynamic_prompt.md
          cat changed_files.txt >> dynamic_prompt.md
          echo '```' >> dynamic_prompt.md

          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ æƒ…å ±ã‚’è¿½åŠ 
          cat >> dynamic_prompt.md << 'PROMPT_STRUCTURE'

          ### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ï¼ˆå‚è€ƒæƒ…å ±ï¼‰

          ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ä»¥ä¸‹ã®æ§‹é€ ã‚’æŒã£ã¦ã„ã¾ã™ã€‚é–¢æ•°ã‚„ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã¨æ€ã£ã¦ã‚‚ã€åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã§ã™ï¼š

          ```
          backend/
          â”œâ”€â”€ cmd/api/           # APIã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ
          â”œâ”€â”€ cmd/worker/        # Workerã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ
          â””â”€â”€ internal/
              â”œâ”€â”€ domain/        # ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®šç¾©
              â”œâ”€â”€ usecase/       # ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
              â”œâ”€â”€ handler/       # HTTPãƒãƒ³ãƒ‰ãƒ©
              â”œâ”€â”€ repository/    # ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆinterface + implï¼‰
              â”œâ”€â”€ adapter/       # å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹é€£æº
              â””â”€â”€ engine/        # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã‚¨ãƒ³ã‚¸ãƒ³

          frontend/
          â”œâ”€â”€ pages/             # Nuxtãƒšãƒ¼ã‚¸
          â”œâ”€â”€ components/        # Vueã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
          â”œâ”€â”€ composables/       # Composition API composables
          â””â”€â”€ types/             # TypeScriptå‹å®šç¾©
          ```

          **æ³¨æ„**: Goè¨€èªã§ã¯åŒä¸€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å†…ã®åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã§é–¢æ•°ã‚„ãƒ¡ã‚½ãƒƒãƒ‰ãŒå®šç¾©ã•ã‚Œã‚‹ã“ã¨ãŒä¸€èˆ¬çš„ã§ã™ã€‚
          ã€Œã“ã®é–¢æ•°ã®å®Ÿè£…ãŒãªã„ã€ã¨ã„ã†æŒ‡æ‘˜ã¯è¦‹å½“é•ã„ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
          PROMPT_STRUCTURE

          cat >> dynamic_prompt.md << 'PROMPT_MID'

          ---

          ### å·®åˆ†ã®è©³ç´°ï¼ˆunified diffå½¢å¼ï¼‰

          ä»¥ä¸‹ãŒã“ã®PRã®å…¨å·®åˆ†ã§ã™ã€‚**ã“ã®å·®åˆ†ã«å«ã¾ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰ã®ã¿**ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ï¼š

          ```diff
          PROMPT_MID

          # å·®åˆ†ã‚’ç›´æ¥åŸ‹ã‚è¾¼ã‚€ï¼ˆã‚µã‚¤ã‚ºåˆ¶é™ï¼š100KBï¼‰
          DIFF_SIZE=$(wc -c < pr_diff.patch | tr -d ' ')
          if [ "$DIFF_SIZE" -gt 100000 ]; then
            echo "... (å·®åˆ†ãŒå¤§ãã™ãã‚‹ãŸã‚çœç•¥ã€å„å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥ç¢ºèªã—ã¦ãã ã•ã„)" >> dynamic_prompt.md
            # ä»£ã‚ã‚Šã«ãƒ•ã‚¡ã‚¤ãƒ«ã”ã¨ã®å·®åˆ†æ¦‚è¦ã‚’å‡ºåŠ›
            head -500 pr_diff.patch >> dynamic_prompt.md
            echo "... (ä»¥ä¸‹çœç•¥)" >> dynamic_prompt.md
          else
            cat pr_diff.patch >> dynamic_prompt.md
          fi

          cat >> dynamic_prompt.md << 'PROMPT_FOOTER'
          ```

          ---

          ## ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

          PROMPT_FOOTER

          # é™çš„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ 
          cat .github/codex/prompts/review.md >> dynamic_prompt.md

          echo "Dynamic prompt generated"
          PROMPT_SIZE=$(wc -c < dynamic_prompt.md | tr -d ' ')
          PROMPT_LINES=$(wc -l < dynamic_prompt.md | tr -d ' ')
          echo "Prompt size: $PROMPT_SIZE bytes, $PROMPT_LINES lines"

      - name: Run Codex Review
        if: steps.diff.outputs.has_changes == 'true'
        id: codex_review
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt-file: dynamic_prompt.md
          output-file: codex-review-output.json
          output-schema-file: .github/codex/schemas/review-schema.json
          safety-strategy: drop-sudo
          sandbox: workspace-write
          model: o4-mini
          effort: medium

      - name: Skip if no changes
        if: steps.diff.outputs.has_changes != 'true'
        id: skip
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const body = [
              '## ğŸ¤– Codex Code Review',
              '',
              '### æ¦‚è¦',
              'ã“ã®PRã«ã¯ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆbaseãƒ–ãƒ©ãƒ³ãƒã¨å·®åˆ†ãªã—ï¼‰ã€‚',
              '',
              '### åˆ¤å®š',
              '**APPROVE**',
              'å¤‰æ›´ãŒãªã„ãŸã‚ã€å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚',
              '',
              '---',
              '*ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ [OpenAI Codex](https://openai.com/codex/) ã«ã‚ˆã‚‹è‡ªå‹•ç”Ÿæˆã§ã™*'
            ].join('\n');

            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              body: body,
              event: 'APPROVE'
            });

            console.log('No changes detected, auto-approved');
            core.setOutput('skipped', 'true');

      - name: Process Review Results
        if: steps.diff.outputs.has_changes == 'true'
        id: process
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ github.event.pull_request.number || inputs.pr_number }}
        with:
          script: |
            const fs = require('fs');

            // ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’èª­ã¿è¾¼ã¿
            let review;
            try {
              const content = fs.readFileSync('codex-review-output.json', 'utf8');
              review = JSON.parse(content);
            } catch (e) {
              console.log('Failed to parse JSON, falling back to markdown output');
              core.setOutput('fallback', 'true');
              return;
            }

            const prNumber = process.env.PR_NUMBER;

            // æ–°ã—ã„ã‚¹ã‚­ãƒ¼ãƒã«å¯¾å¿œï¼ˆpr_findings ã¨ other_findingsï¼‰
            const prFindings = review.pr_findings || [];
            const otherFindings = review.other_findings || [];

            // çµæœã‚’å‡ºåŠ›
            core.setOutput('verdict', review.verdict || 'COMMENT');
            core.setOutput('summary', review.summary || '');
            core.setOutput('verdict_reason', review.verdict_reason || '');
            core.setOutput('good_points', JSON.stringify(review.good_points || []));
            core.setOutput('pr_findings', JSON.stringify(prFindings));
            core.setOutput('other_findings', JSON.stringify(otherFindings));
            core.setOutput('has_other_findings', otherFindings.length > 0 ? 'true' : 'false');
            core.setOutput('fallback', 'false');

            console.log(`PR Findings: ${prFindings.length}`);
            console.log(`Other Findings: ${otherFindings.length}`);
            console.log(`Verdict: ${review.verdict}`);

      - name: Post PR Review (Structured)
        if: steps.diff.outputs.has_changes == 'true' && steps.process.outputs.fallback != 'true'
        uses: actions/github-script@v7
        env:
          VERDICT: ${{ steps.process.outputs.verdict }}
          SUMMARY: ${{ steps.process.outputs.summary }}
          VERDICT_REASON: ${{ steps.process.outputs.verdict_reason }}
          GOOD_POINTS: ${{ steps.process.outputs.good_points }}
          PR_FINDINGS: ${{ steps.process.outputs.pr_findings }}
        with:
          script: |
            const prNumber = context.issue.number;
            const verdict = process.env.VERDICT;
            const summary = process.env.SUMMARY;
            const verdictReason = process.env.VERDICT_REASON;
            const goodPoints = JSON.parse(process.env.GOOD_POINTS || '[]');
            const prFindings = JSON.parse(process.env.PR_FINDINGS || '[]');

            // ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã‚’æ§‹ç¯‰
            let body = `## ğŸ¤– Codex Code Review\n\n`;
            body += `### æ¦‚è¦\n${summary}\n\n`;

            if (goodPoints.length > 0) {
              body += `### è‰¯ã„ç‚¹\n`;
              goodPoints.forEach(p => body += `- ${p}\n`);
              body += '\n';
            }

            // é‡è¦åº¦åˆ¥ã«åˆ†é¡
            const critical = prFindings.filter(f => f.severity === 'critical');
            const high = prFindings.filter(f => f.severity === 'high');
            const medium = prFindings.filter(f => f.severity === 'medium');
            const low = prFindings.filter(f => f.severity === 'low');

            if (critical.length > 0 || high.length > 0) {
              body += `### ğŸš¨ è¦ä¿®æ­£ï¼ˆPRå·®åˆ†ã«é–¢ã™ã‚‹æŒ‡æ‘˜ï¼‰\n`;
              [...critical, ...high].forEach(f => {
                const severity = f.severity === 'critical' ? 'ğŸ”´ Critical' : 'ğŸŸ  High';
                body += `#### ${severity}: ${f.title}\n`;
                body += `**ãƒ•ã‚¡ã‚¤ãƒ«**: \`${f.file}${f.start_line ? ':' + f.start_line : ''}\`\n`;
                body += `${f.body}\n`;
                if (f.suggested_code) {
                  body += `\n\`\`\`suggestion\n${f.suggested_code}\n\`\`\`\n`;
                }
                body += '\n';
              });
            }

            if (medium.length > 0 || low.length > 0) {
              body += `### ğŸ’¡ æ”¹å–„ææ¡ˆï¼ˆPRå·®åˆ†ã«é–¢ã™ã‚‹æŒ‡æ‘˜ï¼‰\n`;
              [...medium, ...low].forEach(f => {
                const severity = f.severity === 'medium' ? 'ğŸŸ¡ Medium' : 'ğŸŸ¢ Low';
                body += `#### ${severity}: ${f.title}\n`;
                body += `**ãƒ•ã‚¡ã‚¤ãƒ«**: \`${f.file}${f.start_line ? ':' + f.start_line : ''}\`\n`;
                body += `${f.body}\n\n`;
              });
            }

            if (prFindings.length === 0) {
              body += `### âœ… PRå·®åˆ†ã«é–¢ã™ã‚‹æŒ‡æ‘˜\nãªã—\n\n`;
            }

            body += `### åˆ¤å®š\n**${verdict}**\n${verdictReason}\n\n`;
            body += `---\n*ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ [OpenAI Codex](https://openai.com/codex/) ã«ã‚ˆã‚‹è‡ªå‹•ç”Ÿæˆã§ã™*\n`;
            body += `*ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³: [AGENTS.md](../AGENTS.md)*`;

            // PR Reviewã‚’æŠ•ç¨¿
            const event = verdict === 'APPROVE' ? 'APPROVE' :
                          verdict === 'REQUEST_CHANGES' ? 'REQUEST_CHANGES' : 'COMMENT';

            try {
              // æ—¢å­˜ã®botãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’dismissï¼ˆAPPROVEã®é‡è¤‡ã‚’é˜²ãï¼‰
              const { data: reviews } = await github.rest.pulls.listReviews({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });

              for (const review of reviews) {
                if (review.user.login === 'github-actions[bot]' &&
                    (review.state === 'APPROVED' || review.state === 'CHANGES_REQUESTED')) {
                  try {
                    await github.rest.pulls.dismissReview({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      pull_number: prNumber,
                      review_id: review.id,
                      message: 'æ–°ã—ã„Codexãƒ¬ãƒ“ãƒ¥ãƒ¼ã«ç½®ãæ›ãˆã‚‰ã‚Œã¾ã—ãŸ'
                    });
                    console.log(`Dismissed previous review #${review.id}`);
                  } catch (e) {
                    console.log(`Could not dismiss review #${review.id}: ${e.message}`);
                  }
                }
              }

              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                body: body,
                event: event
              });

              console.log(`Posted PR Review with verdict: ${event}`);
            } catch (e) {
              // ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿ã«å¤±æ•—ã—ãŸå ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
              console.log(`Failed to post review: ${e.message}, falling back to comment`);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body + `\n\n*Note: PR Reviewã¨ã—ã¦æŠ•ç¨¿ã§ããªã‹ã£ãŸãŸã‚ã€ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æŠ•ç¨¿ã—ã¾ã—ãŸ*`
              });
            }

      - name: Post PR Review (Fallback - Markdown)
        if: steps.diff.outputs.has_changes == 'true' && steps.process.outputs.fallback == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number || inputs.pr_number }}
        run: |
          if [ -f codex-review-output.json ]; then
            CONTENT=$(cat codex-review-output.json)
          else
            CONTENT="ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
          fi

          gh pr comment $PR_NUMBER --body "## ğŸ¤– Codex Code Review

          $CONTENT

          ---
          *ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ [OpenAI Codex](https://openai.com/codex/) ã«ã‚ˆã‚‹è‡ªå‹•ç”Ÿæˆã§ã™*"

      - name: Create Issues for Other Findings
        if: steps.diff.outputs.has_changes == 'true' && steps.process.outputs.has_other_findings == 'true'
        id: create_issues
        uses: actions/github-script@v7
        env:
          OTHER_FINDINGS: ${{ steps.process.outputs.other_findings }}
          PR_NUMBER: ${{ github.event.pull_request.number || inputs.pr_number }}
        with:
          script: |
            const otherFindings = JSON.parse(process.env.OTHER_FINDINGS || '[]');
            const prNumber = process.env.PR_NUMBER;
            const createdIssues = [];

            if (otherFindings.length === 0) return;

            // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const byCategory = {};
            otherFindings.forEach(f => {
              const cat = f.category || 'quality';
              if (!byCategory[cat]) byCategory[cat] = [];
              byCategory[cat].push(f);
            });

            const categoryLabels = {
              'security': 'codex:security',
              'performance': 'codex:performance',
              'quality': 'codex:quality',
              'test': 'codex:test',
              'documentation': 'codex:documentation'
            };

            const categoryTitles = {
              'security': 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ”¹å–„',
              'performance': 'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„',
              'quality': 'ã‚³ãƒ¼ãƒ‰å“è³ªæ”¹å–„',
              'test': 'ãƒ†ã‚¹ãƒˆæ”¹å–„',
              'documentation': 'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ”¹å–„'
            };

            for (const [category, findings] of Object.entries(byCategory)) {
              const label = categoryLabels[category] || 'codex:quality';
              const titlePrefix = categoryTitles[category] || 'ã‚³ãƒ¼ãƒ‰æ”¹å–„';

              // æ—¢å­˜ã®Issueã‚’æ¤œç´¢
              const { data: existingIssues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: label,
                state: 'open',
                per_page: 10
              });

              // æŒ‡æ‘˜å†…å®¹ã‚’Markdownå½¢å¼ã«å¤‰æ›
              let findingsBody = findings.map(f => {
                const severity = f.severity === 'critical' ? 'ğŸ”´' :
                                 f.severity === 'high' ? 'ğŸŸ ' :
                                 f.severity === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢';
                let content = `### ${severity} ${f.title}\n`;
                content += `**ãƒ•ã‚¡ã‚¤ãƒ«**: \`${f.file}${f.start_line ? ':' + f.start_line : ''}\`\n`;
                content += `**é‡è¦åº¦**: ${f.severity}\n\n`;
                content += `${f.body}\n`;
                if (f.suggested_code) {
                  content += `\n**ä¿®æ­£æ¡ˆ**:\n\`\`\`\n${f.suggested_code}\n\`\`\`\n`;
                }
                return content;
              }).join('\n---\n\n');

              const prRef = `\n\n---\n*PR #${prNumber} ã®Codexãƒ¬ãƒ“ãƒ¥ãƒ¼ã§æ¤œå‡º*`;

              let issueNumber;
              let issueAction;

              if (existingIssues.length > 0) {
                // æ—¢å­˜Issueã«è¿½è¨˜
                const existingIssue = existingIssues[0];
                const newBody = existingIssue.body + `\n\n---\n\n## PR #${prNumber} ã‹ã‚‰ã®è¿½åŠ æŒ‡æ‘˜\n\n${findingsBody}${prRef}`;

                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue.number,
                  body: newBody
                });

                issueNumber = existingIssue.number;
                issueAction = 'updated';
                console.log(`Updated existing issue #${existingIssue.number} with ${findings.length} findings`);
              } else {
                // æ–°è¦Issueä½œæˆ
                const title = `[Codex] ${titlePrefix}ã®æŒ‡æ‘˜äº‹é …`;
                const body = `## æ¦‚è¦\n\nCodexã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã€PRã®å·®åˆ†å¤–ã§ä»¥ä¸‹ã®æ”¹å–„ç‚¹ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚\n\n${findingsBody}${prRef}`;

                const { data: newIssue } = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: title,
                  body: body,
                  labels: [label, 'codex:auto-generated']
                });

                issueNumber = newIssue.number;
                issueAction = 'created';
                console.log(`Created new issue #${newIssue.number} for ${category} findings`);
              }

              createdIssues.push({
                number: issueNumber,
                action: issueAction,
                category: category,
                title: titlePrefix,
                findingsCount: findings.length
              });
            }

            // ä½œæˆ/æ›´æ–°ã—ãŸIssueæƒ…å ±ã‚’å‡ºåŠ›
            core.setOutput('created_issues', JSON.stringify(createdIssues));

      - name: Report Issues in PR Comment
        if: steps.diff.outputs.has_changes == 'true' && steps.process.outputs.has_other_findings == 'true'
        uses: actions/github-script@v7
        env:
          CREATED_ISSUES: ${{ steps.create_issues.outputs.created_issues }}
          OTHER_FINDINGS: ${{ steps.process.outputs.other_findings }}
          PR_NUMBER: ${{ github.event.pull_request.number || inputs.pr_number }}
        with:
          script: |
            const createdIssues = JSON.parse(process.env.CREATED_ISSUES || '[]');
            const otherFindings = JSON.parse(process.env.OTHER_FINDINGS || '[]');
            const prNumber = context.issue.number;

            if (createdIssues.length === 0) return;

            let body = `## ğŸ“‹ PRå·®åˆ†å¤–ã§ç™ºè¦‹ã—ãŸèª²é¡Œ\n\n`;
            body += `ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã«ã€PRã®å·®åˆ†å¤–ã§ä»¥ä¸‹ã®æ”¹å–„ç‚¹ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚\n`;
            body += `ã“ã‚Œã‚‰ã¯ **Issue** ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚\n\n`;

            // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ã¾ã¨ã‚ã¦è¡¨ç¤º
            for (const issue of createdIssues) {
              const actionText = issue.action === 'created' ? 'æ–°è¦ä½œæˆ' : 'æ—¢å­˜ã«è¿½åŠ ';
              body += `### ${issue.title}\n`;
              body += `- **Issue**: #${issue.number} (${actionText})\n`;
              body += `- **æŒ‡æ‘˜æ•°**: ${issue.findingsCount}ä»¶\n\n`;
            }

            // è©³ç´°ã‚µãƒãƒªãƒ¼
            body += `### æ¤œå‡ºã•ã‚ŒãŸèª²é¡Œã®è©³ç´°\n`;
            otherFindings.forEach(f => {
              const severity = f.severity === 'critical' ? 'ğŸ”´' :
                               f.severity === 'high' ? 'ğŸŸ ' :
                               f.severity === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢';
              body += `- ${severity} **${f.title}** (\`${f.file}\`)\n`;
            });

            body += `\n---\n`;
            body += `*ã“ã‚Œã‚‰ã®èª²é¡Œã¯PRã®åˆ¤å®šï¼ˆAPPROVE/REQUEST_CHANGESï¼‰ã«ã¯å½±éŸ¿ã—ã¾ã›ã‚“ã€‚*\n`;
            body += `*å¯¾å¿œãŒå¿…è¦ãªå ´åˆã¯ã€åˆ¥é€”PRã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

            console.log(`Posted issue summary comment on PR #${prNumber}`);

      - name: Add Labels
        if: steps.diff.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        env:
          VERDICT: ${{ steps.process.outputs.verdict }}
        with:
          script: |
            const verdict = process.env.VERDICT || 'COMMENT';
            const prNumber = context.issue.number;

            // æ—¢å­˜ã®codex:review-ãƒ©ãƒ™ãƒ«ã‚’å‰Šé™¤
            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            for (const label of currentLabels) {
              if (label.name.startsWith('codex:review-')) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  name: label.name
                }).catch(() => {});
              }
            }

            // æ–°ã—ã„ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
            const labelMap = {
              'APPROVE': 'codex:review-approved',
              'REQUEST_CHANGES': 'codex:review-changes-requested',
              'COMMENT': 'codex:review-commented'
            };

            const newLabel = labelMap[verdict] || 'codex:review-commented';

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: [newLabel]
            });

            console.log(`Added label: ${newLabel}`);

      - name: Handle Review Failure
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number || inputs.pr_number }}
        run: |
          gh pr comment $PR_NUMBER --body "## âš ï¸ Codex Review Failed

          è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚
          æ‰‹å‹•ã§ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚

          [ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ---
          *ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯ Codex Review Workflow ã«ã‚ˆã‚‹è‡ªå‹•ç”Ÿæˆã§ã™*"
