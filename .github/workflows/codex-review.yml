# Codex PR Review Workflow
# PRãŒä½œæˆãƒ»æ›´æ–°ã•ã‚ŒãŸéš›ã«OpenAI CodexãŒã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œ
#
# è¨­å®šæ–¹æ³•:
# 1. ãƒªãƒã‚¸ãƒˆãƒªã® Settings > Secrets and variables > Actions ã§ OPENAI_API_KEY ã‚’è¨­å®š
# 2. PRãŒä½œæˆã•ã‚Œã‚‹ã¨è‡ªå‹•çš„ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå®Ÿè¡Œã•ã‚Œã‚‹
#
# å‚ç…§:
# - https://developers.openai.com/codex/github-action/
# - https://github.com/openai/codex-action
# - AGENTS.md: Codexç”¨ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

name: Codex PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼ã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: false
        type: number

# PRã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆæ›¸ãè¾¼ã¿æ¨©é™
permissions:
  contents: read
  pull-requests: write

jobs:
  codex-review:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆå·®åˆ†æ¯”è¼ƒç”¨ï¼‰

      - name: Run Codex Review
        id: codex_review
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt-file: .github/codex/prompts/review.md
          output-file: codex-review-output.md
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: sudoæ¨©é™ã‚’å‰Šé™¤ã—ã¦CodexãŒAPIã‚­ãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã‚ˆã†ã«ã™ã‚‹
          safety-strategy: drop-sudo
          # ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã¸ã®æ›¸ãè¾¼ã¿ã‚’è¨±å¯ï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœå‡ºåŠ›ç”¨ï¼‰
          sandbox: workspace-write
          # ãƒ¢ãƒ‡ãƒ«ã‚’æŒ‡å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: o4-miniï¼‰
          # åˆ©ç”¨å¯èƒ½ãªãƒ¢ãƒ‡ãƒ«: o4-mini, gpt-4o, gpt-4-turbo ãªã©
          model: o4-mini

      - name: Post Review Comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number || inputs.pr_number }}
        run: |
          if [ -f codex-review-output.md ]; then
            # ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
            gh pr comment $PR_NUMBER --body "## ğŸ¤– Codex Code Review

          $(cat codex-review-output.md)

          ---
          *ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ [OpenAI Codex](https://openai.com/codex/) ã«ã‚ˆã‚‹è‡ªå‹•ç”Ÿæˆã§ã™*
          *ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³: [AGENTS.md](../AGENTS.md)*"
          else
            echo "Review output file not found"
            exit 1
          fi

      - name: Handle Review Failure
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number || inputs.pr_number }}
        run: |
          gh pr comment $PR_NUMBER --body "## âš ï¸ Codex Review Failed

          è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚
          æ‰‹å‹•ã§ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚

          [ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ---
          *ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯ Codex Review Workflow ã«ã‚ˆã‚‹è‡ªå‹•ç”Ÿæˆã§ã™*"
