# Claude Code PR Review Workflow
# PRãŒä½œæˆãƒ»æ›´æ–°ã•ã‚ŒãŸéš›ã«Claude CodeãŒã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œ

name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼ã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: number

# PRã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆæ›¸ãè¾¼ã¿æ¨©é™
permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  review:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆå·®åˆ†æ¯”è¼ƒç”¨ï¼‰

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Run Claude Code Review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number || inputs.pr_number }}
        run: |
          # PRã®å·®åˆ†ã‚’å–å¾—
          PR_DIFF=$(gh pr diff $PR_NUMBER)

          # PRã®æƒ…å ±ã‚’å–å¾—
          PR_TITLE=$(gh pr view $PR_NUMBER --json title -q '.title')
          PR_BODY=$(gh pr view $PR_NUMBER --json body -q '.body')

          echo "Reviewing PR #$PR_NUMBER: $PR_TITLE"

          # Claude Codeã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œ
          REVIEW_RESULT=$(claude -p "
          ã‚ãªãŸã¯ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®Pull Requestã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

          ## PRæƒ…å ±
          - ã‚¿ã‚¤ãƒˆãƒ«: $PR_TITLE
          - èª¬æ˜: $PR_BODY

          ## å¤‰æ›´å·®åˆ†
          \`\`\`diff
          $PR_DIFF
          \`\`\`

          ## ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹
          1. **ã‚³ãƒ¼ãƒ‰å“è³ª**: å¯èª­æ€§ã€ä¿å®ˆæ€§ã€DRYåŸå‰‡
          2. **ãƒã‚°ãƒ»å•é¡Œç‚¹**: æ½œåœ¨çš„ãªãƒã‚°ã€ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
          3. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã€XSSã€èªè¨¼ãƒ»èªå¯ã®å•é¡Œ
          4. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: N+1ã‚¯ã‚¨ãƒªã€ä¸è¦ãªãƒ«ãƒ¼ãƒ—ã€ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯
          5. **ãƒ†ã‚¹ãƒˆ**: ãƒ†ã‚¹ãƒˆã®æœ‰ç„¡ã€ã‚«ãƒãƒ¬ãƒƒã‚¸
          6. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: å¿…è¦ãªã‚³ãƒ¡ãƒ³ãƒˆã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°

          ## å‡ºåŠ›å½¢å¼
          ä»¥ä¸‹ã®å½¢å¼ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

          ### æ¦‚è¦
          ï¼ˆå¤‰æ›´å†…å®¹ã®è¦ç´„ï¼‰

          ### è‰¯ã„ç‚¹ âœ…
          ï¼ˆè‰¯ã„å¤‰æ›´ç‚¹ãŒã‚ã‚Œã°è¨˜è¼‰ï¼‰

          ### æ”¹å–„ææ¡ˆ ğŸ’¡
          ï¼ˆæ”¹å–„ãŒæœ›ã¾ã—ã„ç‚¹ï¼‰

          ### è¦ä¿®æ­£ âš ï¸
          ï¼ˆä¿®æ­£ãŒå¿…è¦ãªå•é¡Œç‚¹ï¼‰

          ### ç·åˆè©•ä¾¡
          ï¼ˆApprove / Request Changes / Comment ã®ã„ãšã‚Œã‹ï¼‰
          " --max-turns 1)

          # ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
          gh pr comment $PR_NUMBER --body "## ğŸ¤– Claude Code Review

          $REVIEW_RESULT

          ---
          *ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯Claude Codeã«ã‚ˆã‚‹è‡ªå‹•ç”Ÿæˆã§ã™*"

      - name: Handle Review Failure
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number || inputs.pr_number }}
        run: |
          gh pr comment $PR_NUMBER --body "## âš ï¸ Claude Code Review Failed

          è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚
          æ‰‹å‹•ã§ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚

          [ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ---
          *ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯Claude Code Review Workflowã«ã‚ˆã‚‹è‡ªå‹•ç”Ÿæˆã§ã™*"
