# AI ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ“ãƒ«ãƒ€ãƒ¼ å®Ÿè£…è¨ˆç”»

> **Status**: ğŸ“‹ è¨ˆç”»ä¸­
> **Created**: 2026-01-18
> **Author**: AI Agent
> **Depends on**: [PHASE10_COPILOT.md](./PHASE10_COPILOT.md) - æ—¢å­˜ Copilot æ©Ÿèƒ½ã‚’æ‹¡å¼µ

---

## æ¦‚è¦

ã€Œã€‡ã€‡ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ä½œã£ã¦ã€ã¨ã„ã†ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è‡ªç„¶è¨€èªå…¥åŠ›ã‹ã‚‰ã€AI ãŒå¯¾è©±çš„ã«ãƒ’ã‚¢ãƒªãƒ³ã‚°ã‚’è¡Œã„ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’è‡ªå¾‹çš„ã«æ§‹ç¯‰ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã€‚

### è¨­è¨ˆåŸå‰‡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  AI ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ“ãƒ«ãƒ€ãƒ¼ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã€Œå–¶æ¥­ãƒ¬ãƒãƒ¼ãƒˆã‚’è‡ªå‹•åŒ–ã—ã¦ã€                                     â”‚
â”‚       â”‚                                                                  â”‚
â”‚       â–¼                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    Phase 1: ãƒ’ã‚¢ãƒªãƒ³ã‚°                               â”‚â”‚
â”‚  â”‚                                                                       â”‚â”‚
â”‚  â”‚  AI: ã€Œå–¶æ¥­ãƒ¬ãƒãƒ¼ãƒˆã®è‡ªå‹•åŒ–ã«ã¤ã„ã¦ãŠèãã—ã¾ã™ã€‚ã€                     â”‚â”‚
â”‚  â”‚      ã€Œãƒ¬ãƒãƒ¼ãƒˆã®æœ€çµ‚å½¢å¼ã¯ä½•ã§ã™ã‹ï¼Ÿï¼ˆPDF/Excel/Slacké€šçŸ¥ï¼‰ã€          â”‚â”‚
â”‚  â”‚      ã€Œèª°ã‹ã®æ‰¿èªã¯å¿…è¦ã§ã™ã‹ï¼Ÿã€                                       â”‚â”‚
â”‚  â”‚      ã€Œã©ã®ãã‚‰ã„ã®é »åº¦ã§å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿã€                               â”‚â”‚
â”‚  â”‚                                                                       â”‚â”‚
â”‚  â”‚  â†’ å†…éƒ¨DSLï¼ˆWorkflowSpecï¼‰ã¨ã—ã¦æ­£è¦åŒ–                                â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚       â”‚                                                                  â”‚
â”‚       â–¼                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    Phase 2: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ§‹ç¯‰                          â”‚â”‚
â”‚  â”‚                                                                       â”‚â”‚
â”‚  â”‚  WorkflowSpec â†’ Steps + Edges + BlockGroups                          â”‚â”‚
â”‚  â”‚                                                                       â”‚â”‚
â”‚  â”‚  - ãƒ—ãƒªã‚»ãƒƒãƒˆãƒ–ãƒ­ãƒƒã‚¯ã¸ã®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆæœ€å„ªå…ˆï¼‰                          â”‚â”‚
â”‚  â”‚  - ã‚«ã‚¹ã‚¿ãƒ ãƒ–ãƒ­ãƒƒã‚¯å€™è£œã®æ¤œå‡º                                          â”‚â”‚
â”‚  â”‚  - ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ãƒ»ã‚¹ã‚­ãƒ¼ãƒã®è‡ªå‹•ç”Ÿæˆ                                     â”‚â”‚
â”‚  â”‚  - æ¡ä»¶åˆ†å²ãƒ»ä¾‹å¤–å‡¦ç†ã®çµ„ã¿è¾¼ã¿                                        â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚       â”‚                                                                  â”‚
â”‚       â–¼                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    Phase 3: ãƒ¦ãƒ¼ã‚¶ãƒ¼æç¤ºãƒ»ãƒ–ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—             â”‚â”‚
â”‚  â”‚                                                                       â”‚â”‚
â”‚  â”‚  AI: ã€Œã“ã¡ã‚‰ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸï¼šã€                           â”‚â”‚
â”‚  â”‚      ã€Œ[ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å›³ã‚’è¡¨ç¤º]ã€                                         â”‚â”‚
â”‚  â”‚      ã€Œâš ï¸ Google Sheets é€£æºã¯ã‚«ã‚¹ã‚¿ãƒ ä½œæˆãŒå¿…è¦ã§ã™ã€                  â”‚â”‚
â”‚  â”‚                                                                       â”‚â”‚
â”‚  â”‚  ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã€Œæ‰¿èªã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ ã—ã¦ã€                                   â”‚â”‚
â”‚  â”‚  AI: ã€Œæ‰¿èªã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚æ‰¿èªè€…ã¯èª°ã§ã™ã‹ï¼Ÿã€                 â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚       â”‚                                                                  â”‚
â”‚       â–¼                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    Phase 4: ç¢ºå®šãƒ»ä¿å­˜                                â”‚â”‚
â”‚  â”‚                                                                       â”‚â”‚
â”‚  â”‚  - Project ã¨ã—ã¦ä¿å­˜ï¼ˆdraft çŠ¶æ…‹ï¼‰                                    â”‚â”‚
â”‚  â”‚  - ãƒãƒ¼ã‚¸ãƒ§ãƒ³å±¥æ­´ã¨ã—ã¦è¨˜éŒ²                                            â”‚â”‚
â”‚  â”‚  - ã‚«ã‚¹ã‚¿ãƒ ä½œæˆã‚¿ã‚¹ã‚¯ã®ç”Ÿæˆ                                            â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã¨ã®çµ±åˆ

### ä¾å­˜ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | ç”¨é€” | ç¾çŠ¶ |
|---------------|------|------|
| Copilot API | åŸºç›¤ API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | âœ… å®Ÿè£…æ¸ˆã¿ |
| CopilotSession | ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç† | âœ… å®Ÿè£…æ¸ˆã¿ |
| Block Registry | åˆ©ç”¨å¯èƒ½ãƒ–ãƒ­ãƒƒã‚¯ä¸€è¦§ | âœ… 46 ãƒ–ãƒ­ãƒƒã‚¯ |
| Workflow Engine | ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ | âœ… å®Ÿè£…æ¸ˆã¿ |
| Project/Step/Edge | ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ« | âœ… å®Ÿè£…æ¸ˆã¿ |

### æ‹¡å¼µãƒã‚¤ãƒ³ãƒˆ

| æ‹¡å¼µ | èª¬æ˜ |
|------|------|
| æ–°è¦ã‚·ã‚¹ãƒ†ãƒ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ | `ai-builder-*` ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç¾¤ |
| WorkflowSpec DSL | ãƒ’ã‚¢ãƒªãƒ³ã‚°çµæœã®å†…éƒ¨è¡¨ç¾ |
| ãƒ“ãƒ«ãƒ€ãƒ¼ã‚¨ãƒ³ã‚¸ãƒ³ | DSL â†’ Project å¤‰æ› |
| å¯¾è©±å‹ UI | æ—¢å­˜ CopilotPanel ã®æ‹¡å¼µ |

---

## ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

### WorkflowSpecï¼ˆå†…éƒ¨ DSLï¼‰

ãƒ’ã‚¢ãƒªãƒ³ã‚°çµæœã‚’æ©Ÿæ¢°çš„ã«æ‰±ãˆã‚‹å½¢å¼ã«æ­£è¦åŒ–ã—ãŸã‚‚ã®ã€‚

```typescript
interface WorkflowSpec {
  // === ãƒ¡ã‚¿æƒ…å ± ===
  id: string                        // ã‚»ãƒƒã‚·ãƒ§ãƒ³å›ºæœ‰ID
  name: string                      // ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å
  description: string               // èª¬æ˜

  // === ãƒ“ã‚¸ãƒã‚¹è¦ä»¶ ===
  purpose: string                   // ç›®çš„ãƒ»ã‚´ãƒ¼ãƒ«
  successCriteria: string[]         // æˆåŠŸæ¡ä»¶
  businessDomain: BusinessDomain    // æ¥­å‹™ã‚«ãƒ†ã‚´ãƒª

  // === é–‹å§‹ãƒ»çµ‚äº† ===
  trigger: TriggerSpec              // é–‹å§‹æ¡ä»¶
  completion: CompletionSpec        // å®Œäº†æ¡ä»¶

  // === é–¢ä¸è€… ===
  actors: ActorSpec[]               // é–¢ä¸ã™ã‚‹äººç‰©ãƒ»å½¹å‰²

  // === ã‚¹ãƒ†ãƒƒãƒ— ===
  steps: StepSpec[]                 // å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—

  // === å¤–éƒ¨é€£æº ===
  integrations: IntegrationSpec[]   // åˆ©ç”¨ãƒ„ãƒ¼ãƒ«ãƒ»API

  // === åˆ¶ç´„ ===
  constraints: ConstraintSpec       // åˆ¶ç´„æ¡ä»¶

  // === ä»®å®š ===
  assumptions: Assumption[]         // AI ãŒä»®å®šã—ãŸå‰æ

  // === ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ ===
  heardAt: Date                     // ãƒ’ã‚¢ãƒªãƒ³ã‚°å®Œäº†æ—¥æ™‚
  version: number                   // ã‚¹ãƒšãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³
}

interface TriggerSpec {
  type: 'manual' | 'schedule' | 'webhook' | 'event'
  schedule?: string                 // cron å¼
  eventSource?: string              // ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚¹
  description: string               // è‡ªç„¶è¨€èªã®èª¬æ˜
}

interface CompletionSpec {
  description: string               // å®Œäº†æ¡ä»¶ã®èª¬æ˜
  outputs: OutputSpec[]             // æˆæœç‰©
}

interface OutputSpec {
  name: string
  type: 'document' | 'notification' | 'data' | 'approval' | 'other'
  format?: string                   // PDF, Excel, JSON, etc.
  destination?: string              // é€ä¿¡å…ˆ
}

interface ActorSpec {
  role: 'executor' | 'approver' | 'reviewer' | 'viewer'
  description: string               // å½¹å‰²ã®èª¬æ˜
  count: 'single' | 'multiple' | 'optional'
}

interface StepSpec {
  id: string
  name: string
  description: string
  type: StepSpecType
  inputs: string[]                  // å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã®å‚ç…§
  outputs: string[]                 // å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ¼
  config?: Record<string, unknown>  // ãƒ–ãƒ­ãƒƒã‚¯å›ºæœ‰è¨­å®š

  // === ãƒãƒƒãƒ”ãƒ³ã‚°çµæœ ===
  mappedBlock?: {
    slug: string
    confidence: 'high' | 'medium' | 'low'
    customRequired: boolean
    customReason?: string
  }

  // === åˆ†å²ãƒ»ä¾‹å¤– ===
  branches?: BranchSpec[]
  errorHandling?: ErrorHandlingSpec
}

type StepSpecType =
  | 'input'           // ãƒ‡ãƒ¼ã‚¿å…¥åŠ›
  | 'transform'       // ãƒ‡ãƒ¼ã‚¿å¤‰æ›
  | 'decision'        // æ¡ä»¶åˆ†å²
  | 'action'          // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
  | 'notification'    // é€šçŸ¥
  | 'approval'        // æ‰¿èª
  | 'integration'     // å¤–éƒ¨é€£æº
  | 'ai'              // AI å‡¦ç†
  | 'loop'            // ãƒ«ãƒ¼ãƒ—å‡¦ç†
  | 'aggregate'       // é›†è¨ˆ
  | 'wait'            // å¾…æ©Ÿ

interface BranchSpec {
  condition: string                 // æ¡ä»¶ã®èª¬æ˜
  targetStepId: string
}

interface ErrorHandlingSpec {
  onError: 'retry' | 'skip' | 'abort' | 'notify' | 'fallback'
  retryCount?: number
  retryDelay?: number               // ms
  fallbackStepId?: string
  notifyTo?: string
}

interface IntegrationSpec {
  service: string                   // Slack, GitHub, etc.
  operation: string                 // send_message, create_issue
  hasCredentials: boolean           // èªè¨¼æƒ…å ±ã®æœ‰ç„¡
  requiredSecrets: string[]         // å¿…è¦ãªã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼
}

interface ConstraintSpec {
  frequency?: 'once' | 'daily' | 'weekly' | 'monthly' | 'on-demand'
  deadline?: string                 // æœŸé™
  sla?: string                      // SLA
  security?: string[]               // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶
}

interface Assumption {
  id: string
  category: 'trigger' | 'actor' | 'step' | 'integration' | 'constraint'
  description: string               // ä»®å®šã®å†…å®¹
  default: string                   // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
  confirmed: boolean                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªæ¸ˆã¿ã‹
}

type BusinessDomain =
  | 'sales'           // å–¶æ¥­
  | 'development'     // é–‹ç™º
  | 'hr'              // äººäº‹ãƒ»æ¡ç”¨
  | 'finance'         // çµŒç†ãƒ»è²¡å‹™
  | 'marketing'       // ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°
  | 'support'         // ã‚µãƒãƒ¼ãƒˆ
  | 'operations'      // ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  | 'personal'        // å€‹äººã‚¿ã‚¹ã‚¯
  | 'other'           // ãã®ä»–
```

### BuilderSessionï¼ˆãƒ“ãƒ«ãƒ€ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼‰

```typescript
interface BuilderSession {
  id: string
  tenantId: string
  userId: string
  status: BuilderSessionStatus

  // === ãƒ’ã‚¢ãƒªãƒ³ã‚°çŠ¶æ…‹ ===
  hearingPhase: HearingPhase
  hearingProgress: number           // 0-100

  // === ç”Ÿæˆç‰© ===
  spec?: WorkflowSpec               // ãƒ’ã‚¢ãƒªãƒ³ã‚°çµæœ
  projectId?: string                // ç”Ÿæˆã•ã‚ŒãŸ Project ID

  // === ä¼šè©±å±¥æ­´ ===
  messages: BuilderMessage[]

  // === ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ ===
  createdAt: Date
  updatedAt: Date
}

type BuilderSessionStatus =
  | 'hearing'         // ãƒ’ã‚¢ãƒªãƒ³ã‚°ä¸­
  | 'building'        // ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ§‹ç¯‰ä¸­
  | 'reviewing'       // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­
  | 'refining'        // ãƒ–ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—ä¸­
  | 'completed'       // å®Œäº†
  | 'abandoned'       // æ”¾æ£„

type HearingPhase =
  | 'purpose'         // 1.1-1.2 ç›®çš„ãƒ»ã‚´ãƒ¼ãƒ«ç¢ºèª
  | 'conditions'      // 1.3 é–‹å§‹ãƒ»çµ‚äº†æ¡ä»¶
  | 'actors'          // 1.4-1.5 é–¢ä¸è€…ãƒ»æ‰¿èª
  | 'frequency'       // 1.6 å®Ÿè¡Œé »åº¦ãƒ»æœŸé™
  | 'integrations'    // 1.7 ãƒ„ãƒ¼ãƒ«ãƒ»ã‚·ã‚¹ãƒ†ãƒ 
  | 'pain_points'     // 1.8 èª²é¡Œãƒ»å›°ã‚Šã”ã¨
  | 'confirmation'    // 1.9 ä»®å®šæ¡ä»¶ã®ç¢ºèª
  | 'completed'       // ãƒ’ã‚¢ãƒªãƒ³ã‚°å®Œäº†

interface BuilderMessage {
  id: string
  role: 'user' | 'assistant' | 'system'
  content: string
  timestamp: Date

  // === ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ ===
  phase?: HearingPhase
  extractedData?: Partial<WorkflowSpec>
  suggestedQuestions?: string[]
}
```

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ

```sql
-- builder_sessions ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE builder_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    user_id UUID NOT NULL,
    copilot_session_id UUID REFERENCES copilot_sessions(id),

    -- çŠ¶æ…‹
    status VARCHAR(50) NOT NULL DEFAULT 'hearing',
    hearing_phase VARCHAR(50) NOT NULL DEFAULT 'purpose',
    hearing_progress INTEGER NOT NULL DEFAULT 0,

    -- ç”Ÿæˆç‰©
    spec JSONB,
    project_id UUID REFERENCES projects(id),

    -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

    CONSTRAINT valid_status CHECK (status IN (
        'hearing', 'building', 'reviewing', 'refining', 'completed', 'abandoned'
    )),
    CONSTRAINT valid_phase CHECK (hearing_phase IN (
        'purpose', 'conditions', 'actors', 'frequency',
        'integrations', 'pain_points', 'confirmation', 'completed'
    ))
);

-- builder_messages ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE builder_messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id UUID NOT NULL REFERENCES builder_sessions(id) ON DELETE CASCADE,

    role VARCHAR(20) NOT NULL,
    content TEXT NOT NULL,

    -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
    phase VARCHAR(50),
    extracted_data JSONB,
    suggested_questions JSONB,

    -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

    CONSTRAINT valid_role CHECK (role IN ('user', 'assistant', 'system'))
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_builder_sessions_tenant ON builder_sessions(tenant_id);
CREATE INDEX idx_builder_sessions_user ON builder_sessions(user_id);
CREATE INDEX idx_builder_sessions_status ON builder_sessions(status);
CREATE INDEX idx_builder_messages_session ON builder_messages(session_id);
```

---

## ã‚·ã‚¹ãƒ†ãƒ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

### ai-builder-hearingï¼ˆãƒ’ã‚¢ãƒªãƒ³ã‚°ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ai-builder-hearing                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  [Start]                                                                 â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â–¼                                                                    â”‚
â”‚  [Get Session Context]                                                   â”‚
â”‚     â”‚ session_id, current_phase, previous_messages, partial_spec        â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â–¼                                                                    â”‚
â”‚  [Get Available Blocks]                                                  â”‚
â”‚     â”‚ blocks.list() â†’ ãƒ–ãƒ­ãƒƒã‚¯ä¸€è¦§ï¼ˆãƒãƒƒãƒ”ãƒ³ã‚°ç”¨ï¼‰                        â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â–¼                                                                    â”‚
â”‚  [Build Hearing Prompt]                                                  â”‚
â”‚     â”‚ ãƒ•ã‚§ãƒ¼ã‚ºã«å¿œã˜ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ                                      â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â–¼                                                                    â”‚
â”‚  [LLM Call]                                                              â”‚
â”‚     â”‚ provider: anthropic, model: claude-sonnet-4-20250514               â”‚
â”‚     â”‚ structured output: { response, extractedData, nextPhase, ... }    â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â–¼                                                                    â”‚
â”‚  [Parse & Validate]                                                      â”‚
â”‚     â”‚ JSON è§£æã€WorkflowSpec ã¸ã®éƒ¨åˆ†ãƒãƒ¼ã‚¸                             â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â–¼                                                                    â”‚
â”‚  [Update Session]                                                        â”‚
â”‚     â”‚ phase, progress, spec ã®æ›´æ–°                                       â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â–¼                                                                    â”‚
â”‚  [Return Response]                                                       â”‚
â”‚     â”‚ { message, suggestedQuestions, phase, progress, complete }        â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ai-builder-constructï¼ˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ§‹ç¯‰ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ai-builder-construct                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  [Start]                                                                 â”‚
â”‚     â”‚ input: { session_id, spec }                                       â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â–¼                                                                    â”‚
â”‚  [Map Steps to Blocks] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚     â”‚ å„ StepSpec ã‚’ãƒ—ãƒªã‚»ãƒƒãƒˆãƒ–ãƒ­ãƒƒã‚¯ã«ãƒãƒƒãƒ”ãƒ³ã‚°              â”‚       â”‚
â”‚     â”‚                                                            â”‚       â”‚
â”‚     â–¼                                                            â”‚       â”‚
â”‚  [foreach: spec.steps]                                           â”‚       â”‚
â”‚     â”‚                                                            â”‚       â”‚
â”‚     â”œâ”€â–º [Find Best Match]                                        â”‚       â”‚
â”‚     â”‚      â”‚ ãƒ–ãƒ­ãƒƒã‚¯ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‹ã‚‰æœ€é©ãªãƒ–ãƒ­ãƒƒã‚¯ã‚’æ¤œç´¢          â”‚       â”‚
â”‚     â”‚      â”‚ LLM ã«ã‚ˆã‚‹ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒƒãƒãƒ³ã‚°                  â”‚       â”‚
â”‚     â”‚      â”‚                                                      â”‚       â”‚
â”‚     â”‚      â–¼                                                      â”‚       â”‚
â”‚     â”‚   [Check Capability]                                       â”‚       â”‚
â”‚     â”‚      â”‚ ãƒ—ãƒªã‚»ãƒƒãƒˆã§å®Ÿç¾å¯èƒ½ã‹åˆ¤å®š                          â”‚       â”‚
â”‚     â”‚      â”‚ ã‚«ã‚¹ã‚¿ãƒ å¿…è¦ãªå ´åˆã¯ç†ç”±ã‚’è¨˜éŒ²                      â”‚       â”‚
â”‚     â”‚      â”‚                                                      â”‚       â”‚
â”‚     â”‚      â–¼                                                      â”‚       â”‚
â”‚     â”‚   [Generate Config]                                        â”‚       â”‚
â”‚     â”‚      â”‚ ãƒ–ãƒ­ãƒƒã‚¯è¨­å®šã®ç”Ÿæˆ                                  â”‚       â”‚
â”‚     â”‚      â”‚                                                      â”‚       â”‚
â”‚     â””â—„â”€â”€â”€â”€â”€â”˜                                                      â”‚       â”‚
â”‚                                                                   â”‚       â”‚
â”‚     â–¼  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚  [Build Data Flow]                                                       â”‚
â”‚     â”‚ ã‚¹ãƒ†ãƒƒãƒ—é–“ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å®šç¾©                                       â”‚
â”‚     â”‚ ã‚¹ã‚­ãƒ¼ãƒæ¨è«–                                                       â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â–¼                                                                    â”‚
â”‚  [Add Control Flow]                                                      â”‚
â”‚     â”‚ åˆ†å²ãƒ»ä¾‹å¤–å‡¦ç†ãƒ»ãƒ«ãƒ¼ãƒ—ã®è¿½åŠ                                        â”‚
â”‚     â”‚ BlockGroup ã®ç”Ÿæˆ                                                  â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â–¼                                                                    â”‚
â”‚  [Generate Edges]                                                        â”‚
â”‚     â”‚ ã‚¹ãƒ†ãƒƒãƒ—é–“ã®æ¥ç¶šï¼ˆEdgeï¼‰ç”Ÿæˆ                                       â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â–¼                                                                    â”‚
â”‚  [Create Project]                                                        â”‚
â”‚     â”‚ Project, Steps, Edges, BlockGroups ã¨ã—ã¦ä¿å­˜                      â”‚
â”‚     â”‚ status: draft                                                      â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â–¼                                                                    â”‚
â”‚  [Generate Summary]                                                      â”‚
â”‚     â”‚ ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘èª¬æ˜ã®ç”Ÿæˆ                                             â”‚
â”‚     â”‚ ã‚«ã‚¹ã‚¿ãƒ ä½œæˆå¿…è¦ç®‡æ‰€ã®ãƒªã‚¹ãƒˆ                                       â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â–¼                                                                    â”‚
â”‚  [Return Result]                                                         â”‚
â”‚     â”‚ { projectId, summary, customRequirements, warnings }              â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ai-builder-refineï¼ˆãƒ–ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ai-builder-refine                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  [Start]                                                                 â”‚
â”‚     â”‚ input: { session_id, project_id, user_feedback }                  â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â–¼                                                                    â”‚
â”‚  [Get Current Project]                                                   â”‚
â”‚     â”‚ ç¾åœ¨ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®šç¾©ã‚’å–å¾—                                       â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â–¼                                                                    â”‚
â”‚  [Parse Feedback]                                                        â”‚
â”‚     â”‚ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è§£æ                                       â”‚
â”‚     â”‚ å·®åˆ†ç·¨é›†ã®å†…å®¹ã‚’ç‰¹å®š                                               â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â–¼                                                                    â”‚
â”‚  [switch: feedback_type] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚     â”‚                                            â”‚                       â”‚
â”‚     â”œâ”€â–º add_step     â†’ [Add Step]                â”‚                       â”‚
â”‚     â”œâ”€â–º remove_step  â†’ [Remove Step]             â”‚                       â”‚
â”‚     â”œâ”€â–º modify_step  â†’ [Modify Step]             â”‚                       â”‚
â”‚     â”œâ”€â–º add_approval â†’ [Add Approval Step]       â”‚                       â”‚
â”‚     â”œâ”€â–º change_flow  â†’ [Reorganize Flow]         â”‚                       â”‚
â”‚     â””â”€â–º other        â†’ [LLM Interpret]           â”‚                       â”‚
â”‚                                            â”‚     â”‚                       â”‚
â”‚     â–¼  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚  [Update Project]                                                        â”‚
â”‚     â”‚ å¤‰æ›´ã‚’ Project ã«é©ç”¨                                              â”‚
â”‚     â”‚ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ                                           â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â–¼                                                                    â”‚
â”‚  [Validate Changes]                                                      â”‚
â”‚     â”‚ å¤‰æ›´å¾Œã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æ¤œè¨¼                                         â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â–¼                                                                    â”‚
â”‚  [Generate Diff Summary]                                                 â”‚
â”‚     â”‚ å¤‰æ›´å†…å®¹ã®ã‚µãƒãƒªãƒ¼ç”Ÿæˆ                                             â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â–¼                                                                    â”‚
â”‚  [Return Result]                                                         â”‚
â”‚     â”‚ { changes, newVersion, summary }                                  â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## API è¨­è¨ˆ

### ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§

| Method | Path | èª¬æ˜ |
|--------|------|------|
| POST | `/api/v1/builder/sessions` | ãƒ“ãƒ«ãƒ€ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ |
| GET | `/api/v1/builder/sessions/{id}` | ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾— |
| POST | `/api/v1/builder/sessions/{id}/messages` | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ï¼ˆãƒ’ã‚¢ãƒªãƒ³ã‚°é€²è¡Œï¼‰ |
| POST | `/api/v1/builder/sessions/{id}/construct` | ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ§‹ç¯‰é–‹å§‹ |
| POST | `/api/v1/builder/sessions/{id}/refine` | ãƒ–ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ— |
| POST | `/api/v1/builder/sessions/{id}/finalize` | ç¢ºå®šãƒ»ä¿å­˜ |
| DELETE | `/api/v1/builder/sessions/{id}` | ã‚»ãƒƒã‚·ãƒ§ãƒ³ç ´æ£„ |

### Request/Response

#### ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹

```json
// POST /api/v1/builder/sessions
{
  "initial_prompt": "å–¶æ¥­ãƒ¬ãƒãƒ¼ãƒˆã‚’è‡ªå‹•åŒ–ã™ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ä½œã‚ŠãŸã„"
}

// Response
{
  "session_id": "uuid",
  "status": "hearing",
  "phase": "purpose",
  "progress": 10,
  "message": {
    "id": "msg-uuid",
    "role": "assistant",
    "content": "å–¶æ¥­ãƒ¬ãƒãƒ¼ãƒˆã®è‡ªå‹•åŒ–ã‚’ãŠæ‰‹ä¼ã„ã—ã¾ã™ã€‚\n\nã¾ãšã€ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ç›®çš„ã‚’ç¢ºèªã•ã›ã¦ãã ã•ã„ã€‚\næœ€çµ‚çš„ã«ã©ã®ã‚ˆã†ãªçŠ¶æ…‹ã«ãªã‚Œã°æˆåŠŸã¨è¨€ãˆã¾ã™ã‹ï¼Ÿ\n\nä¾‹ï¼š\n- ãƒ¬ãƒãƒ¼ãƒˆãŒPDFã§ç”Ÿæˆã•ã‚Œã‚‹\n- ä¸Šå¸ã«è‡ªå‹•é€ä¿¡ã•ã‚Œã‚‹\n- Slackã§é€šçŸ¥ã•ã‚Œã‚‹",
    "suggested_questions": [
      "ãƒ¬ãƒãƒ¼ãƒˆã®æœ€çµ‚å½¢å¼ã¯ä½•ã§ã™ã‹ï¼Ÿ",
      "ãƒ¬ãƒãƒ¼ãƒˆã¯èª°ã«å±Šãã¾ã™ã‹ï¼Ÿ"
    ]
  }
}
```

#### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡

```json
// POST /api/v1/builder/sessions/{id}/messages
{
  "content": "æ¯é€±æœˆæ›œæ—¥ã«PDFã§ä¸Šå¸ã«é€ä¿¡ã—ãŸã„"
}

// Response (polling ç”¨ã® run_id ã‚’è¿”å´)
{
  "run_id": "uuid",
  "status": "pending"
}

// GET /api/v1/copilot/runs/{run_id} (ãƒãƒ¼ãƒªãƒ³ã‚°)
// Response (å®Œäº†æ™‚)
{
  "run_id": "uuid",
  "status": "completed",
  "output": {
    "message": {
      "id": "msg-uuid",
      "role": "assistant",
      "content": "æ‰¿çŸ¥ã—ã¾ã—ãŸã€‚æ¯é€±æœˆæ›œæ—¥ã«PDFã‚’ç”Ÿæˆã—ã¦ä¸Šå¸ã«é€ä¿¡ã™ã‚‹ã®ã§ã™ã­ã€‚\n\næ¬¡ã«ã€ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’é–‹å§‹ã™ã‚‹ãƒˆãƒªã‚¬ãƒ¼ã‚’ç¢ºèªã•ã›ã¦ãã ã•ã„ã€‚\næœˆæ›œæ—¥ã®ä½•æ™‚ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿã¾ãŸã€ãƒ‡ãƒ¼ã‚¿ã®ã‚½ãƒ¼ã‚¹ã¯ä½•ã§ã™ã‹ï¼Ÿ",
      "extracted_data": {
        "trigger": {
          "type": "schedule",
          "schedule": "0 9 * * 1",
          "description": "æ¯é€±æœˆæ›œæ—¥"
        },
        "completion": {
          "outputs": [
            { "name": "é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ", "type": "document", "format": "PDF" }
          ]
        }
      }
    },
    "session": {
      "phase": "conditions",
      "progress": 25
    }
  }
}
```

#### ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ§‹ç¯‰

```json
// POST /api/v1/builder/sessions/{id}/construct
// (spec ã¯è‡ªå‹•çš„ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å–å¾—)

// Response
{
  "run_id": "uuid",
  "status": "pending"
}

// GET /api/v1/copilot/runs/{run_id} (ãƒãƒ¼ãƒªãƒ³ã‚°)
// Response (å®Œäº†æ™‚)
{
  "run_id": "uuid",
  "status": "completed",
  "output": {
    "project_id": "proj-uuid",
    "summary": {
      "name": "é€±æ¬¡å–¶æ¥­ãƒ¬ãƒãƒ¼ãƒˆè‡ªå‹•åŒ–",
      "description": "æ¯é€±æœˆæ›œæ—¥ã«å–¶æ¥­ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆã—ã€PDFãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦ä¸Šå¸ã«é€ä¿¡ã—ã¾ã™ã€‚",
      "steps_count": 5,
      "has_approval": false,
      "trigger": "schedule (æ¯é€±æœˆæ›œ 9:00)"
    },
    "step_mappings": [
      { "name": "ãƒ‡ãƒ¼ã‚¿å–å¾—", "block": "http", "confidence": "high" },
      { "name": "ãƒ‡ãƒ¼ã‚¿å¤‰æ›", "block": "function", "confidence": "high" },
      { "name": "PDFç”Ÿæˆ", "block": null, "custom_required": true, "reason": "PDFç”Ÿæˆãƒ–ãƒ­ãƒƒã‚¯ãŒæœªå®Ÿè£…" },
      { "name": "ãƒ¡ãƒ¼ãƒ«é€ä¿¡", "block": "email_sendgrid", "confidence": "high" }
    ],
    "custom_requirements": [
      {
        "name": "PDFç”Ÿæˆãƒ–ãƒ­ãƒƒã‚¯",
        "description": "HTMLã‹ã‚‰PDFã‚’ç”Ÿæˆã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒ–ãƒ­ãƒƒã‚¯",
        "inputs": { "html": "string" },
        "outputs": { "pdf_url": "string" },
        "estimated_effort": "medium"
      }
    ],
    "warnings": [
      "SENDGRID_API_KEY ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®è¨­å®šãŒå¿…è¦ã§ã™"
    ]
  }
}
```

---

## ãƒ’ã‚¢ãƒªãƒ³ã‚°ãƒ•ãƒ­ãƒ¼è©³ç´°

### Phase 1.1-1.2: ç›®çš„ãƒ»ã‚´ãƒ¼ãƒ«ç¢ºèª

```typescript
const purposePhasePrompt = `
ã‚ãªãŸã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ“ãƒ«ãƒ€ãƒ¼AIã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œ${userInput}ã€ã¨ã„ã†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ä½œã‚ŠãŸã„ã¨è¨€ã£ã¦ã„ã¾ã™ã€‚

ä»¥ä¸‹ã®è¦³ç‚¹ã§ãƒ’ã‚¢ãƒªãƒ³ã‚°ã‚’è¡Œã£ã¦ãã ã•ã„ï¼š

1. **ä¾é ¼å†…å®¹ã®ç‰¹å®š**
   - ã€Œ${userInput}ã€ãŒæŒ‡ã™å…·ä½“çš„ãªæ¥­å‹™ãƒ»ä½œæ¥­ã‚’ç¢ºèª
   - æŠ½è±¡çš„ãªå ´åˆã¯ã€æ¥­å‹™ã‚«ãƒ†ã‚´ãƒªã‚’æç¤ºã—ã¦é¸æŠã•ã›ã‚‹

2. **ã‚´ãƒ¼ãƒ«ã®ç¢ºèª**
   - ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§æœ€çµ‚çš„ã«ä½•ãŒé”æˆã•ã‚Œã‚Œã°æˆåŠŸã‹
   - æˆæœç‰©ãŒã‚ã‚Œã°ã€ãã®å½¢å¼ã‚„çŠ¶æ…‹ã‚’ç¢ºèª

ã€å‡ºåŠ›å½¢å¼ã€‘
{
  "response": "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®è¿”ç­”ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸",
  "extractedData": {
    "purpose": "æ¨æ¸¬ã•ã‚ŒãŸç›®çš„",
    "businessDomain": "sales|development|hr|...",
    "successCriteria": ["æˆåŠŸæ¡ä»¶1", ...]
  },
  "suggestedQuestions": ["æ¬¡ã«èãã¹ãè³ªå•1", ...],
  "nextPhase": "purpose|conditions",
  "confidence": "high|medium|low"
}
`;
```

### Phase 1.3: é–‹å§‹ãƒ»çµ‚äº†æ¡ä»¶

```typescript
const conditionsPhasePrompt = `
ç¾åœ¨ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä»•æ§˜ï¼š
${JSON.stringify(currentSpec, null, 2)}

ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

1. **é–‹å§‹æ¡ä»¶**
   - ã„ã¤ãƒ»ã©ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã“ã®ãƒ•ãƒ­ãƒ¼ãŒå§‹ã¾ã‚‹ã‹
   - ãƒˆãƒªã‚¬ãƒ¼ã®ç¨®é¡ï¼ˆæ‰‹å‹•ã€å®šæœŸå®Ÿè¡Œã€Webhookã€ã‚¤ãƒ™ãƒ³ãƒˆï¼‰

2. **çµ‚äº†æ¡ä»¶**
   - ã©ã®çŠ¶æ…‹ã«ãªã£ãŸã‚‰å®Œäº†ã¨ã¿ãªã™ã‹
   - æ˜ç¢ºã§ãªã‘ã‚Œã°ä¸€èˆ¬çš„ãªæ¡ä»¶ã‚’ä»®ç½®ã

ã€å‡ºåŠ›å½¢å¼ã€‘
{
  "response": "...",
  "extractedData": {
    "trigger": { "type": "...", "schedule": "...", "description": "..." },
    "completion": { "description": "...", "outputs": [...] }
  },
  ...
}
`;
```

### Phase 1.4-1.5: é–¢ä¸è€…ãƒ»æ‰¿èª

```typescript
const actorsPhasePrompt = `
ç¾åœ¨ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä»•æ§˜ï¼š
${JSON.stringify(currentSpec, null, 2)}

ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

1. **ä½œæ¥­è€…**
   - ä½œæ¥­ã‚’å®Ÿè¡Œã™ã‚‹äººï¼ˆæ‹…å½“è€…ï¼‰
   - è¤‡æ•°äººã„ã‚‹å ´åˆã¯å½¹å‰²å˜ä½ã§æ•´ç†

2. **æ‰¿èªãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼**
   - æ‰¿èªã‚„ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¿…è¦ã‹
   - å¿…è¦ãªå ´åˆï¼šæ‰¿èªè€…ã€ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€å·®ã—æˆ»ã—æ™‚ã®æ‰±ã„

ã€å‡ºåŠ›å½¢å¼ã€‘
{
  "response": "...",
  "extractedData": {
    "actors": [
      { "role": "executor|approver|reviewer", "description": "...", "count": "single|multiple" }
    ]
  },
  ...
}
`;
```

### Phase 1.6-1.9: é »åº¦ãƒ»ãƒ„ãƒ¼ãƒ«ãƒ»èª²é¡Œãƒ»ç¢ºèª

åŒæ§˜ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã§å„ãƒ•ã‚§ãƒ¼ã‚ºã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å®šç¾©ã€‚

---

## ãƒ–ãƒ­ãƒƒã‚¯ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯

### ãƒãƒƒãƒ”ãƒ³ã‚°ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

```typescript
interface BlockMappingResult {
  blockSlug: string | null
  confidence: 'high' | 'medium' | 'low'
  customRequired: boolean
  customReason?: string
  suggestedConfig?: Record<string, unknown>
}

async function mapStepToBlock(
  step: StepSpec,
  availableBlocks: BlockDefinition[],
  llmService: LLMService
): Promise<BlockMappingResult> {
  // 1. ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã®ç›´æ¥ãƒãƒƒãƒãƒ³ã‚°
  const directMatch = findDirectMatch(step, availableBlocks)
  if (directMatch) {
    return {
      blockSlug: directMatch.slug,
      confidence: 'high',
      customRequired: false
    }
  }

  // 2. ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒƒãƒãƒ³ã‚°ï¼ˆLLMä½¿ç”¨ï¼‰
  const semanticMatch = await findSemanticMatch(step, availableBlocks, llmService)
  if (semanticMatch.confidence !== 'low') {
    return semanticMatch
  }

  // 3. ã‚«ã‚¹ã‚¿ãƒ ãƒ–ãƒ­ãƒƒã‚¯å€™è£œã¨ã—ã¦å ±å‘Š
  return {
    blockSlug: null,
    confidence: 'low',
    customRequired: true,
    customReason: analyzeCustomRequirement(step)
  }
}

function findDirectMatch(step: StepSpec, blocks: BlockDefinition[]): BlockDefinition | null {
  const typeToBlockMap: Record<StepSpecType, string[]> = {
    'input': ['start'],
    'transform': ['function', 'map', 'filter'],
    'decision': ['condition', 'switch', 'router'],
    'action': ['function', 'http'],
    'notification': ['slack', 'discord', 'email_sendgrid'],
    'approval': ['human_in_loop'],
    'integration': ['http', 'github_create_issue', 'notion_create_page', ...],
    'ai': ['llm', 'router', 'rag-query'],
    'loop': ['foreach', 'while'],  // BlockGroup
    'aggregate': ['aggregate'],
    'wait': ['wait']
  }

  const candidates = typeToBlockMap[step.type] || []
  for (const slug of candidates) {
    const block = blocks.find(b => b.slug === slug)
    if (block && matchesCapabilities(step, block)) {
      return block
    }
  }
  return null
}

async function findSemanticMatch(
  step: StepSpec,
  blocks: BlockDefinition[],
  llmService: LLMService
): Promise<BlockMappingResult> {
  const prompt = `
ä»¥ä¸‹ã®ã‚¹ãƒ†ãƒƒãƒ—ä»•æ§˜ã«æœ€ã‚‚é©ã—ãŸãƒ–ãƒ­ãƒƒã‚¯ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚

ã€ã‚¹ãƒ†ãƒƒãƒ—ä»•æ§˜ã€‘
åå‰: ${step.name}
èª¬æ˜: ${step.description}
ç¨®é¡: ${step.type}

ã€åˆ©ç”¨å¯èƒ½ãªãƒ–ãƒ­ãƒƒã‚¯ã€‘
${blocks.map(b => `- ${b.slug}: ${b.description}`).join('\n')}

ã€å‡ºåŠ›å½¢å¼ã€‘
{
  "blockSlug": "æœ€é©ãªãƒ–ãƒ­ãƒƒã‚¯ã®slugã€ãªã‘ã‚Œã°null",
  "confidence": "high|medium|low",
  "reason": "é¸æŠç†ç”±",
  "suggestedConfig": { è¨­å®šã®ææ¡ˆ }
}
`

  const response = await llmService.chat({
    messages: [{ role: 'user', content: prompt }],
    responseFormat: 'json'
  })

  return JSON.parse(response.content)
}
```

### ã‚«ã‚¹ã‚¿ãƒ ãƒ–ãƒ­ãƒƒã‚¯è¦ä»¶ã®åˆ†æ

```typescript
function analyzeCustomRequirement(step: StepSpec): string {
  const reasons: string[] = []

  // æœªå¯¾å¿œã®å¤–éƒ¨API
  if (step.type === 'integration' && !isKnownIntegration(step)) {
    reasons.push(`æœªå¯¾å¿œã®å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹é€£æº: ${step.description}`)
  }

  // è¤‡é›‘ãªå¤‰æ›
  if (step.type === 'transform' && hasComplexTransformation(step)) {
    reasons.push('è¤‡é›‘ãªãƒ‡ãƒ¼ã‚¿å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯ãŒå¿…è¦')
  }

  // ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰ã®è¨ˆç®—
  if (requiresDomainSpecificLogic(step)) {
    reasons.push('ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰ã®è¨ˆç®—ãƒ»ãƒ­ã‚¸ãƒƒã‚¯ãŒå¿…è¦')
  }

  return reasons.join('; ') || 'æ±ç”¨ãƒ–ãƒ­ãƒƒã‚¯ã§ã¯è¡¨ç¾ã§ããªã„å‡¦ç†'
}
```

---

## ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è¨­è¨ˆ

### ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆ

```
frontend/
â”œâ”€â”€ components/
â”‚   â””â”€â”€ builder/
â”‚       â”œâ”€â”€ BuilderPanel.vue           # ãƒ¡ã‚¤ãƒ³ãƒ‘ãƒãƒ«
â”‚       â”œâ”€â”€ BuilderChat.vue            # ãƒãƒ£ãƒƒãƒˆUI
â”‚       â”œâ”€â”€ BuilderMessage.vue         # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
â”‚       â”œâ”€â”€ BuilderProgress.vue        # ãƒ’ã‚¢ãƒªãƒ³ã‚°é€²æ—
â”‚       â”œâ”€â”€ BuilderAssumptions.vue     # ä»®å®šæ¡ä»¶è¡¨ç¤º
â”‚       â”œâ”€â”€ WorkflowPreview.vue        # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
â”‚       â”œâ”€â”€ StepMappingList.vue        # ãƒ–ãƒ­ãƒƒã‚¯ãƒãƒƒãƒ”ãƒ³ã‚°çµæœ
â”‚       â”œâ”€â”€ CustomRequirements.vue     # ã‚«ã‚¹ã‚¿ãƒ è¦ä»¶ãƒªã‚¹ãƒˆ
â”‚       â””â”€â”€ BuilderActions.vue         # ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
â””â”€â”€ composables/
    â””â”€â”€ useBuilder.ts                  # ãƒ“ãƒ«ãƒ€ãƒ¼APIå‘¼ã³å‡ºã—
```

### useBuilder.ts

```typescript
export function useBuilder() {
  const session = ref<BuilderSession | null>(null)
  const messages = ref<BuilderMessage[]>([])
  const isLoading = ref(false)
  const currentRunId = ref<string | null>(null)
  const { $api } = useNuxtApp()

  async function startSession(initialPrompt: string): Promise<void> {
    isLoading.value = true
    try {
      const response = await $api.post('/builder/sessions', {
        initial_prompt: initialPrompt
      })
      session.value = response
      messages.value = [response.message]
    } finally {
      isLoading.value = false
    }
  }

  async function sendMessage(content: string): Promise<void> {
    if (!session.value) return

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å³åº§ã«è¿½åŠ 
    const userMessage: BuilderMessage = {
      id: nanoid(),
      role: 'user',
      content,
      timestamp: new Date()
    }
    messages.value.push(userMessage)

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    const loadingMessage: BuilderMessage = {
      id: nanoid(),
      role: 'assistant',
      content: 'è€ƒãˆä¸­...',
      timestamp: new Date()
    }
    messages.value.push(loadingMessage)

    // APIã‚³ãƒ¼ãƒ«
    const { run_id } = await $api.post(
      `/builder/sessions/${session.value.id}/messages`,
      { content }
    )
    currentRunId.value = run_id

    // ãƒãƒ¼ãƒªãƒ³ã‚°
    await pollForResult(loadingMessage.id)
  }

  async function pollForResult(loadingMessageId: string): Promise<void> {
    while (currentRunId.value) {
      await sleep(1000)

      const run = await $api.get(`/copilot/runs/${currentRunId.value}`)

      if (run.status === 'completed') {
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’çµæœã§ç½®æ›
        const idx = messages.value.findIndex(m => m.id === loadingMessageId)
        if (idx >= 0) {
          messages.value[idx] = run.output.message
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹æ›´æ–°
        if (run.output.session) {
          session.value = {
            ...session.value!,
            ...run.output.session
          }
        }

        currentRunId.value = null
        return
      }

      if (run.status === 'failed') {
        const idx = messages.value.findIndex(m => m.id === loadingMessageId)
        if (idx >= 0) {
          messages.value[idx] = {
            id: loadingMessageId,
            role: 'assistant',
            content: `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${run.error}`,
            timestamp: new Date()
          }
        }
        currentRunId.value = null
        return
      }
    }
  }

  async function constructWorkflow(): Promise<ConstructionResult | null> {
    if (!session.value) return null

    const { run_id } = await $api.post(
      `/builder/sessions/${session.value.id}/construct`
    )
    currentRunId.value = run_id

    // ãƒãƒ¼ãƒªãƒ³ã‚°ã§çµæœã‚’å¾…ã¤
    while (currentRunId.value) {
      await sleep(1000)
      const run = await $api.get(`/copilot/runs/${currentRunId.value}`)

      if (run.status === 'completed') {
        currentRunId.value = null
        return run.output
      }

      if (run.status === 'failed') {
        currentRunId.value = null
        throw new Error(run.error)
      }
    }

    return null
  }

  async function refineWorkflow(feedback: string): Promise<RefineResult | null> {
    if (!session.value) return null

    const { run_id } = await $api.post(
      `/builder/sessions/${session.value.id}/refine`,
      { feedback }
    )

    // åŒæ§˜ã«ãƒãƒ¼ãƒªãƒ³ã‚°
    // ...
  }

  async function finalizeWorkflow(): Promise<void> {
    if (!session.value) return

    await $api.post(`/builder/sessions/${session.value.id}/finalize`)
    session.value.status = 'completed'
  }

  function cancel(): void {
    currentRunId.value = null
  }

  return {
    session,
    messages,
    isLoading,
    startSession,
    sendMessage,
    constructWorkflow,
    refineWorkflow,
    finalizeWorkflow,
    cancel
  }
}
```

### BuilderPanel.vue

```vue
<template>
  <aside class="builder-panel" :class="{ open: isOpen }">
    <header class="builder-header">
      <h3>
        <Icon name="wand-2" />
        ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ“ãƒ«ãƒ€ãƒ¼
      </h3>
      <button @click="close">
        <Icon name="x" />
      </button>
    </header>

    <!-- ãƒ’ã‚¢ãƒªãƒ³ã‚°é€²æ— -->
    <BuilderProgress
      v-if="session?.status === 'hearing'"
      :phase="session.hearingPhase"
      :progress="session.hearingProgress"
    />

    <div class="builder-content">
      <!-- åˆæœŸç”»é¢ -->
      <div v-if="!session" class="builder-start">
        <p>ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’è‡ªç„¶è¨€èªã§èª¬æ˜ã—ã¦ãã ã•ã„ã€‚AIãŒãƒ’ã‚¢ãƒªãƒ³ã‚°ã‚’è¡Œã„ã€æœ€é©ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚</p>
        <textarea
          v-model="initialPrompt"
          placeholder="ä¾‹: æ¯é€±æœˆæ›œæ—¥ã«å–¶æ¥­ãƒ‡ãƒ¼ã‚¿ã‚’ã¾ã¨ã‚ã¦ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã€ä¸Šå¸ã«ãƒ¡ãƒ¼ãƒ«ã§é€ä¿¡ã—ãŸã„"
          rows="4"
        />
        <button @click="start" :disabled="!initialPrompt.trim()">
          ãƒ“ãƒ«ãƒ€ãƒ¼ã‚’é–‹å§‹
        </button>
      </div>

      <!-- ãƒãƒ£ãƒƒãƒˆ -->
      <div v-else class="builder-chat">
        <div class="messages" ref="messagesRef">
          <BuilderMessage
            v-for="msg in messages"
            :key="msg.id"
            :message="msg"
          />
        </div>

        <!-- ä»®å®šæ¡ä»¶ã®ç¢ºèª -->
        <BuilderAssumptions
          v-if="session.status === 'hearing' && session.hearingPhase === 'confirmation'"
          :assumptions="session.spec?.assumptions || []"
          @confirm="handleAssumptionConfirm"
        />

        <!-- ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
        <WorkflowPreview
          v-if="session.status === 'reviewing'"
          :project-id="session.projectId"
          :summary="constructionResult?.summary"
        />

        <!-- ã‚«ã‚¹ã‚¿ãƒ è¦ä»¶ -->
        <CustomRequirements
          v-if="constructionResult?.custom_requirements?.length"
          :requirements="constructionResult.custom_requirements"
        />
      </div>
    </div>

    <footer class="builder-footer">
      <!-- ãƒ’ã‚¢ãƒªãƒ³ã‚°ä¸­ -->
      <template v-if="session?.status === 'hearing'">
        <input
          v-model="userInput"
          @keypress.enter="sendMessage"
          :placeholder="currentPlaceholder"
          :disabled="isLoading"
        />
        <button @click="sendMessage" :disabled="!userInput.trim() || isLoading">
          é€ä¿¡
        </button>
      </template>

      <!-- ãƒ’ã‚¢ãƒªãƒ³ã‚°å®Œäº†å¾Œ -->
      <template v-else-if="session?.hearingPhase === 'completed'">
        <button @click="construct" :disabled="isLoading" class="primary">
          ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æ§‹ç¯‰
        </button>
      </template>

      <!-- ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ -->
      <template v-else-if="session?.status === 'reviewing'">
        <input
          v-model="refineFeedback"
          @keypress.enter="refine"
          placeholder="å¤‰æ›´ã—ãŸã„ç‚¹ã‚’å…¥åŠ›..."
          :disabled="isLoading"
        />
        <button @click="refine" :disabled="!refineFeedback.trim() || isLoading">
          å¤‰æ›´
        </button>
        <button @click="finalize" :disabled="isLoading" class="primary">
          ç¢ºå®š
        </button>
      </template>
    </footer>
  </aside>
</template>

<script setup lang="ts">
const {
  session,
  messages,
  isLoading,
  startSession,
  sendMessage: send,
  constructWorkflow,
  refineWorkflow,
  finalizeWorkflow
} = useBuilder()

const initialPrompt = ref('')
const userInput = ref('')
const refineFeedback = ref('')
const constructionResult = ref<ConstructionResult | null>(null)

async function start() {
  await startSession(initialPrompt.value)
  initialPrompt.value = ''
}

async function sendMessage() {
  if (!userInput.value.trim()) return
  const content = userInput.value
  userInput.value = ''
  await send(content)
}

async function construct() {
  constructionResult.value = await constructWorkflow()
}

async function refine() {
  if (!refineFeedback.value.trim()) return
  const feedback = refineFeedback.value
  refineFeedback.value = ''
  await refineWorkflow(feedback)
}

async function finalize() {
  await finalizeWorkflow()
  emit('workflow-created', session.value?.projectId)
}

const currentPlaceholder = computed(() => {
  const phase = session.value?.hearingPhase
  const placeholders: Record<HearingPhase, string> = {
    'purpose': 'ä½•ã‚’é”æˆã—ãŸã„ã§ã™ã‹ï¼Ÿ',
    'conditions': 'ã„ã¤ã€ã©ã®ã‚ˆã†ã«é–‹å§‹ãƒ»çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ',
    'actors': 'èª°ãŒé–¢ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
    'frequency': 'ã©ã®ãã‚‰ã„ã®é »åº¦ã§å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ',
    'integrations': 'ä½¿ç”¨ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
    'pain_points': 'ç¾åœ¨ã®èª²é¡Œã¯ä½•ã§ã™ã‹ï¼Ÿ',
    'confirmation': 'ä¸Šè¨˜ã®å‰æã§ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ',
    'completed': ''
  }
  return placeholders[phase || 'purpose'] || 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...'
})
</script>
```

---

## å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚º

### Phase 1: ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ãƒ»åŸºç›¤ï¼ˆ3æ—¥ï¼‰

| ã‚¿ã‚¹ã‚¯ | å·¥æ•° |
|--------|------|
| builder_sessions, builder_messages ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ | 0.5æ—¥ |
| BuilderSession, BuilderMessage ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ« | 0.5æ—¥ |
| WorkflowSpec å‹å®šç¾© | 0.5æ—¥ |
| Repository å®Ÿè£… | 1æ—¥ |
| Handler åŸºç›¤å®Ÿè£… | 0.5æ—¥ |

### Phase 2: ãƒ’ã‚¢ãƒªãƒ³ã‚°ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆ4æ—¥ï¼‰

| ã‚¿ã‚¹ã‚¯ | å·¥æ•° |
|--------|------|
| ai-builder-hearing ã‚·ã‚¹ãƒ†ãƒ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®šç¾© | 1æ—¥ |
| å„ãƒ•ã‚§ãƒ¼ã‚ºã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ | 1.5æ—¥ |
| ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯ | 0.5æ—¥ |
| ãƒ†ã‚¹ãƒˆãƒ»èª¿æ•´ | 1æ—¥ |

### Phase 3: æ§‹ç¯‰ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆ5æ—¥ï¼‰

| ã‚¿ã‚¹ã‚¯ | å·¥æ•° |
|--------|------|
| ai-builder-construct ã‚·ã‚¹ãƒ†ãƒ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®šç¾© | 1æ—¥ |
| ãƒ–ãƒ­ãƒƒã‚¯ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ | 1.5æ—¥ |
| ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ãƒ»ã‚¨ãƒƒã‚¸ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ | 1æ—¥ |
| Project ç”Ÿæˆãƒ»ä¿å­˜ | 0.5æ—¥ |
| ãƒ†ã‚¹ãƒˆãƒ»èª¿æ•´ | 1æ—¥ |

### Phase 4: ãƒ–ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ï¼ˆ3æ—¥ï¼‰

| ã‚¿ã‚¹ã‚¯ | å·¥æ•° |
|--------|------|
| ai-builder-refine ã‚·ã‚¹ãƒ†ãƒ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®šç¾© | 1æ—¥ |
| å·®åˆ†ç·¨é›†ãƒ­ã‚¸ãƒƒã‚¯ | 1æ—¥ |
| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†çµ±åˆ | 0.5æ—¥ |
| ãƒ†ã‚¹ãƒˆãƒ»èª¿æ•´ | 0.5æ—¥ |

### Phase 5: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆ5æ—¥ï¼‰

| ã‚¿ã‚¹ã‚¯ | å·¥æ•° |
|--------|------|
| useBuilder.ts Composable | 1æ—¥ |
| BuilderPanel, BuilderChat ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | 1.5æ—¥ |
| WorkflowPreview, StepMappingList | 1æ—¥ |
| ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¨ãƒ‡ã‚£ã‚¿ã¸ã®çµ±åˆ | 1æ—¥ |
| ãƒ†ã‚¹ãƒˆãƒ»èª¿æ•´ | 0.5æ—¥ |

### Phase 6: E2E ãƒ†ã‚¹ãƒˆãƒ»å“è³ªå‘ä¸Šï¼ˆ3æ—¥ï¼‰

| ã‚¿ã‚¹ã‚¯ | å·¥æ•° |
|--------|------|
| E2E ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªä½œæˆ | 1æ—¥ |
| ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚° | 1.5æ—¥ |
| ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹å¯¾å¿œ | 0.5æ—¥ |

### å·¥æ•°ã‚µãƒãƒªãƒ¼

| ãƒ•ã‚§ãƒ¼ã‚º | å·¥æ•° |
|---------|------|
| Phase 1: ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ãƒ»åŸºç›¤ | 3æ—¥ |
| Phase 2: ãƒ’ã‚¢ãƒªãƒ³ã‚°ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ | 4æ—¥ |
| Phase 3: æ§‹ç¯‰ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ | 5æ—¥ |
| Phase 4: ãƒ–ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ | 3æ—¥ |
| Phase 5: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ | 5æ—¥ |
| Phase 6: E2E ãƒ†ã‚¹ãƒˆãƒ»å“è³ªå‘ä¸Š | 3æ—¥ |
| **åˆè¨ˆ** | **23æ—¥** |

---

## ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

### ãƒ’ã‚¢ãƒªãƒ³ã‚°ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®åŸå‰‡

1. **1ãƒ•ã‚§ãƒ¼ã‚º1è³ªå•**
   - ä¸€åº¦ã«è¤‡æ•°ã®è¦³ç‚¹ã‚’èã‹ãªã„
   - å›ç­”ã‚’å¾—ãŸã‚‰æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºã¸

2. **é¸æŠè‚¢ã®æç¤º**
   - æŠ½è±¡çš„ãªå ´åˆã¯å…·ä½“ä¾‹ã‚’æç¤º
   - ã€Œã¯ã„/ã„ã„ãˆã€ã§ç­”ãˆã‚‰ã‚Œã‚‹è³ªå•ã‚’æ··ãœã‚‹

3. **ä»®å®šã®æ˜ç¤º**
   - æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆã¯ä»®å®šã‚’æç¤º
   - ã€Œã€‡ã€‡ã¨ä»®å®šã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿã€

4. **é€²æ—ã®å¯è¦–åŒ–**
   - æ®‹ã‚Šä½•ãƒ•ã‚§ãƒ¼ã‚ºã‹ã‚’ä¼ãˆã‚‹
   - ã€Œã‚ã¨2ã¤ç¢ºèªã•ã›ã¦ãã ã•ã„ã€

### æ§‹ç¯‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®åŸå‰‡

1. **ãƒ—ãƒªã‚»ãƒƒãƒˆå„ªå…ˆ**
   - ã¾ãšæ—¢å­˜ãƒ–ãƒ­ãƒƒã‚¯ã§å®Ÿç¾ã§ããªã„ã‹æ¤œè¨
   - ã‚«ã‚¹ã‚¿ãƒ ã¯æœ€çµ‚æ‰‹æ®µ

2. **æ§‹é€ åŒ–å‡ºåŠ›**
   - JSON Schema ã§å‡ºåŠ›å½¢å¼ã‚’å³å¯†ã«å®šç¾©
   - ãƒ‘ãƒ¼ã‚¹å¤±æ•—æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

3. **æ¤œè¨¼ã®çµ„ã¿è¾¼ã¿**
   - ç”Ÿæˆã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
   - å¾ªç’°å‚ç…§ã€å­¤ç«‹ãƒãƒ¼ãƒ‰ã®æ¤œå‡º

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

| é …ç›® | å¯¾ç­– |
|------|------|
| ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ | ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã€ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®åˆ†é›¢ |
| æ©Ÿå¯†æƒ…å ±ã®æ¼æ´© | ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼åã®ã¿å‚ç…§ã€å€¤ã¯è¡¨ç¤ºã—ãªã„ |
| ä¸æ­£ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç”Ÿæˆ | ç”Ÿæˆå¾Œã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€å±é™ºãªãƒ–ãƒ­ãƒƒã‚¯ã®åˆ¶é™ |
| ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚¤ã‚¸ãƒ£ãƒƒã‚¯ | ãƒ†ãƒŠãƒ³ãƒˆãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ ID ã®æ¤œè¨¼ |
| éå‰°ãªAPIå‘¼ã³å‡ºã— | ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ |

---

## å°†æ¥ã®æ‹¡å¼µ

| æ©Ÿèƒ½ | èª¬æ˜ |
|------|------|
| **ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª** | ã‚ˆãä½¿ã†ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦ä¿å­˜ãƒ»å…±æœ‰ |
| **å­¦ç¿’æ©Ÿèƒ½** | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‹ã‚‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ”¹å–„ |
| **ãƒãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«å…¥åŠ›** | ç”»åƒã‚„å›³ã‹ã‚‰ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç”Ÿæˆ |
| **ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³** | è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã®å…±åŒç·¨é›† |
| **è‡ªå‹•æœ€é©åŒ–** | å®Ÿè¡Œå±¥æ­´ã‹ã‚‰ã®è‡ªå‹•æ”¹å–„ææ¡ˆ |

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [PHASE10_COPILOT.md](./PHASE10_COPILOT.md) - åŸºç›¤ã¨ãªã‚‹ Copilot æ©Ÿèƒ½
- [UNIFIED_BLOCK_MODEL.md](../designs/UNIFIED_BLOCK_MODEL.md) - ãƒ–ãƒ­ãƒƒã‚¯å®šç¾©ãƒ»å®Ÿè¡Œ
- [BLOCK_REGISTRY.md](../BLOCK_REGISTRY.md) - åˆ©ç”¨å¯èƒ½ãƒ–ãƒ­ãƒƒã‚¯ä¸€è¦§
- [BACKEND.md](../BACKEND.md) - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- [API.md](../API.md) - API è¨­è¨ˆ
