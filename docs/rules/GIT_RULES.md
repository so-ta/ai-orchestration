# Git Rules

Git操作、コミット、PR、コンフリクト解消のルール。

---

## Commit Message Convention

### 形式

```
<type>: <summary>

<body（任意）>
```

### type の種類

| type | 用途 |
|------|------|
| `feat` | 新機能 |
| `fix` | バグ修正 |
| `refactor` | リファクタリング（機能変更なし） |
| `docs` | ドキュメントのみの変更 |
| `test` | テストの追加・修正 |
| `chore` | ビルドプロセス、補助ツールの変更 |

### summary の書き方

- 日本語で記述
- 50文字以内を目安
- 動詞で始める（「追加」「修正」「変更」など）
- 句点（。）は付けない

### コミットのタイミング

| 作業状態 | 判断 |
|---------|------|
| 機能が完成した | コミット |
| テストがパスした | コミット |
| 作業途中だが区切りがよい | コミット |
| ビルドが通らない | **コミットしない** |
| テストが失敗している | **コミットしない** |

### コミット粒度

| 変更内容 | 粒度 |
|---------|------|
| 単一の目的（バグ修正、機能追加など） | 1コミット |
| 複数の独立した変更 | 変更ごとに分割 |
| リファクタリング + 機能追加 | 別コミットに分割 |

---

## Branch Naming

| タイプ | プレフィックス | 例 |
|--------|---------------|-----|
| 新機能 | `feature/` | `feature/add-discord-block` |
| バグ修正 | `fix/` | `fix/workflow-timeout` |
| ドキュメント | `docs/` | `docs/update-api-reference` |

---

## 禁止事項

| 操作 | 理由 |
|------|------|
| `git push --force` to main/master | 履歴破壊 |
| `git reset --hard` on shared branch | 他者の作業を消す |
| シークレットのコミット | セキュリティリスク |
| 巨大なバイナリのコミット | リポジトリ肥大化 |

## 注意が必要な操作

| 操作 | 注意点 |
|------|--------|
| `git commit --amend` | push済みの場合は禁止 |
| `git rebase` | 共有ブランチでは禁止 |
| `.gitignore` の変更 | 影響範囲を確認 |

---

## Conflict Resolution Flow

**PRにpush後、mainブランチとのコンフリクトが発生した場合は、必ず以下のフローで解消すること。**

### コンフリクト解消手順

```bash
# 1. mainブランチの最新を取得
git fetch origin main

# 2. 作業ブランチでマージ
git merge origin/main

# 3. コンフリクトファイルを確認
git status

# 4. コンフリクトを解消
#    - コンフリクトマーカー（<<<<<<, ======, >>>>>>）を削除
#    - 両方の変更を適切にマージ

# 5. 解消したファイルをステージング
git add <resolved-files>

# 6. マージコミットを作成
git commit -m "merge: origin/mainをマージしてコンフリクトを解消"

# 7. リモートにプッシュ
git push origin <branch-name>

# 8. PRのCIが再実行されることを確認
```

### コンフリクト解消のポイント

| ポイント | 説明 |
|---------|------|
| **両方の変更を保持** | 可能な限り、mainブランチとfeatureブランチ両方の変更を維持 |
| **一貫性の確認** | 片方のブランチで変更されたフォーマット・規約に合わせる |
| **コンフリクトマーカー確認** | `grep "<<<<<<" <file>` で残存マーカーがないか確認 |
| **ビルド確認** | 解消後、必ずビルドとテストを実行 |

### 典型的なコンフリクトパターンと対処

| パターン | 対処法 |
|---------|--------|
| seed.sql（データ追加） | 両方のINSERT文を保持。IDの重複に注意 |
| schema.sql（スキーマ変更） | 両方の変更を適用。依存関係を確認 |
| package.json | 両方の依存関係を保持。バージョン競合は最新を選択 |
| 設定ファイル | 両方の設定を統合。重複キーは意図を確認 |

### コンフリクト解消後のチェックリスト

```
1. [ ] コンフリクトマーカーが残っていないことを確認
2. [ ] git status でunmergedパスがないことを確認
3. [ ] ビルドが通ることを確認
4. [ ] テストがパスすることを確認
5. [ ] PRのCIが成功することを確認
```

### ワークツリー使用時の注意

複数のworktreeで作業している場合：

```bash
# worktreeディレクトリに移動
cd /path/to/worktree/<branch-name>

# 通常のgitコマンドで操作
git fetch origin main
git merge origin/main
# ... コンフリクト解消 ...
git push origin <branch-name>
```

---

## Related Documents

- [CODEX_REVIEW.md](./CODEX_REVIEW.md) - PRレビューフロー
- [WORKFLOW_RULES.md](./WORKFLOW_RULES.md) - 開発ワークフロー
