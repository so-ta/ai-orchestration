# Block Group Redesign - ã‚°ãƒ«ãƒ¼ãƒ—ãƒ–ãƒ­ãƒƒã‚¯å†è¨­è¨ˆ

> **Status**: ğŸ“‹ Proposed
> **Created**: 2025-01-15
> **Author**: AI Agent

---

## æ¦‚è¦

ã‚°ãƒ«ãƒ¼ãƒ—ãƒ–ãƒ­ãƒƒã‚¯ã‚’æŠœæœ¬çš„ã«è¦‹ç›´ã—ã€ä»¥ä¸‹ã®åŸå‰‡ã§å†è¨­è¨ˆã™ã‚‹ï¼š

1. **ã‚°ãƒ«ãƒ¼ãƒ—ã¯ body ã®ã¿** - å†…éƒ¨ã«ãƒ­ãƒ¼ãƒ«åˆ†å‰²ã‚’æŒãŸãªã„
2. **IN/OUT ã§åˆ¶å¾¡** - åˆ†å²ãƒ»ã‚¨ãƒ©ãƒ¼å‡¦ç†ã¯å¤–éƒ¨ãƒãƒ¼ãƒˆã§è¡¨ç¾
3. **çµ±å»ƒåˆ** - 6ç¨®é¡ â†’ 4ç¨®é¡ã«æ•´ç†
4. **pre_process / post_process** - é€šå¸¸ãƒ–ãƒ­ãƒƒã‚¯ã¨åŒã˜ä»•çµ„ã¿ã§å…¥å‡ºåŠ›å¤‰æ›

---

## ç¾çŠ¶ã®å•é¡Œç‚¹

### 1. ä¸¦åˆ—å‡¦ç†ã®æ›–æ˜§ã•

```
ç¾çŠ¶ï¼š2ã¤ã®æ–¹æ³•ã§ä¸¦åˆ—å‡¦ç†ãŒç™ºç”Ÿ
â”œâ”€â”€ æš—é»™ã®ä¸¦åˆ—: 1ã¤ã®ãƒ–ãƒ­ãƒƒã‚¯ã‹ã‚‰è¤‡æ•°ãƒ–ãƒ­ãƒƒã‚¯ã«ç·šã‚’å¼•ã
â””â”€â”€ æ˜ç¤ºã®ä¸¦åˆ—: Parallel ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½¿ã†

â†’ ã©ã¡ã‚‰ãŒä¸¦åˆ—ãªã®ã‹åˆ†ã‹ã‚Šã«ãã„
```

### 2. ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®ãƒ­ãƒ¼ãƒ«åˆ†å‰²ãŒè¤‡é›‘

```
ç¾çŠ¶ã® Try-Catch:
â”Œâ”€ Try-Catch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€ TRY â”€â”€â”€â”€â” â”Œâ”€ CATCH â”€â”€â”  â”‚
â”‚  â”‚ [ãƒ–ãƒ­ãƒƒã‚¯] â”‚ â”‚ [ãƒ–ãƒ­ãƒƒã‚¯] â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â†’ ã‚°ãƒ«ãƒ¼ãƒ—å†…ã«ãƒ­ãƒ¼ãƒ«ï¼ˆtry/catch/then/elseï¼‰ãŒæ··åœ¨
â†’ è¦–è¦šçš„ã«è¤‡é›‘ã€ç†è§£ã—ã¥ã‚‰ã„
```

### 3. æ¡ä»¶åˆ†å²ã‚°ãƒ«ãƒ¼ãƒ—ã¨æ¡ä»¶åˆ†å²ãƒ–ãƒ­ãƒƒã‚¯ã®é‡è¤‡

```
ç¾çŠ¶ï¼š
â”œâ”€â”€ if_else ã‚°ãƒ«ãƒ¼ãƒ—ãƒ–ãƒ­ãƒƒã‚¯
â”œâ”€â”€ switch_case ã‚°ãƒ«ãƒ¼ãƒ—ãƒ–ãƒ­ãƒƒã‚¯
â”œâ”€â”€ condition ã‚·ã‚¹ãƒ†ãƒ ãƒ–ãƒ­ãƒƒã‚¯
â””â”€â”€ switch ã‚·ã‚¹ãƒ†ãƒ ãƒ–ãƒ­ãƒƒã‚¯

â†’ åŒã˜æ©Ÿèƒ½ãŒ2ã¤ã®å½¢å¼ã§å­˜åœ¨
```

---

## æ–°è¨­è¨ˆ

### ã‚°ãƒ«ãƒ¼ãƒ—ãƒ–ãƒ­ãƒƒã‚¯ä¸€è¦§ï¼ˆ4ç¨®é¡ï¼‰

| ã‚°ãƒ«ãƒ¼ãƒ— | ç”¨é€” | IN | OUT |
|----------|------|-----|-----|
| `parallel` | ç•°ãªã‚‹å‡¦ç†ã‚’åŒæ™‚å®Ÿè¡Œ | å˜ä¸€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ | é›†ç´„çµæœ / error |
| `try_catch` | ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° | å˜ä¸€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ | success / error |
| `foreach` | åŒã˜å‡¦ç†ã‚’é…åˆ—è¦ç´ ã«é©ç”¨ | é…åˆ— | çµæœé…åˆ— / error |
| `while` | æ¡ä»¶ãƒ«ãƒ¼ãƒ— | å˜ä¸€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ | ãƒ«ãƒ¼ãƒ—çµæœ / error |

### å»ƒæ­¢ã™ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—

| ã‚°ãƒ«ãƒ¼ãƒ— | å»ƒæ­¢ç†ç”± | ä»£æ›¿ |
|----------|----------|------|
| `if_else` | ã‚·ã‚¹ãƒ†ãƒ ãƒ–ãƒ­ãƒƒã‚¯ã§ä»£æ›¿å¯èƒ½ | `condition` ãƒ–ãƒ­ãƒƒã‚¯ |
| `switch_case` | ã‚·ã‚¹ãƒ†ãƒ ãƒ–ãƒ­ãƒƒã‚¯ã§ä»£æ›¿å¯èƒ½ | `switch` ãƒ–ãƒ­ãƒƒã‚¯ |

### å»ƒæ­¢ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ãƒ–ãƒ­ãƒƒã‚¯

| ãƒ–ãƒ­ãƒƒã‚¯ | å»ƒæ­¢ç†ç”± | ä»£æ›¿ |
|----------|----------|------|
| `loop` | ã‚°ãƒ«ãƒ¼ãƒ—ãƒ–ãƒ­ãƒƒã‚¯ã§ä»£æ›¿å¯èƒ½ | `while` ã‚°ãƒ«ãƒ¼ãƒ— |

---

## æ–°ã—ã„ã‚°ãƒ«ãƒ¼ãƒ—æ§‹é€ 

### åŸºæœ¬åŸå‰‡

```
ã€å¤–éƒ¨ã€‘
   â”‚
   â–¼ å¤–éƒ¨ã‹ã‚‰ã® IN
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BlockGroup                                      â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ pre_process (JS)                           â”‚ â”‚
â”‚  â”‚ å¤–éƒ¨ IN â†’ å†…éƒ¨ IN ã¸ã®å¤‰æ›                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                     â”‚                            â”‚
â”‚                     â–¼ å†…éƒ¨ã¸ã® IN                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ body                                       â”‚ â”‚
â”‚  â”‚ [ãƒ–ãƒ­ãƒƒã‚¯] â”€â”€> [ãƒ–ãƒ­ãƒƒã‚¯] â”€â”€> [ãƒ–ãƒ­ãƒƒã‚¯]    â”‚ â”‚
â”‚  â”‚ [ãƒ–ãƒ­ãƒƒã‚¯] â”€â”€> [ãƒ–ãƒ­ãƒƒã‚¯]                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                     â”‚                            â”‚
â”‚                     â–¼ å†…éƒ¨ã‹ã‚‰ã® OUT             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ post_process (JS)                          â”‚ â”‚
â”‚  â”‚ å†…éƒ¨ OUT â†’ å¤–éƒ¨ OUT ã¸ã®å¤‰æ›                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚                              â”‚
   â–¼ å¤–éƒ¨ã¸ã® OUT (success)       â–¼ å¤–éƒ¨ã¸ã® ERROR
ã€å¤–éƒ¨ã€‘                        ã€å¤–éƒ¨ã€‘
```

---

## å„ã‚°ãƒ«ãƒ¼ãƒ—ã®è©³ç´°è¨­è¨ˆ

### 1. Parallelï¼ˆä¸¦åˆ—å®Ÿè¡Œï¼‰

**ç”¨é€”**: ç•°ãªã‚‹å‡¦ç†ã‚’åŒæ™‚ã«å®Ÿè¡Œã—ã€çµæœã‚’é›†ç´„

```
å¤–éƒ¨ IN: { userId: "123", options: {...} }
    â”‚
    â–¼ pre_processï¼ˆå„ãƒ•ãƒ­ãƒ¼ã«åŒã˜å…¥åŠ›ã‚’é…å¸ƒï¼‰

â”Œâ”€ Parallel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                     â”‚
â”‚  ã€ãƒ•ãƒ­ãƒ¼1ã€‘                                        â”‚
â”‚  [APIå‘¼ã³å‡ºã—] â”€â”€> [ãƒ‡ãƒ¼ã‚¿å¤‰æ›]                     â”‚
â”‚                                                     â”‚
â”‚  ã€ãƒ•ãƒ­ãƒ¼2ã€‘                                        â”‚
â”‚  â”Œâ”€ While â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚  [ãƒ«ãƒ¼ãƒ—å‡¦ç†]         â”‚ â”€â”€> [é›†è¨ˆ]              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                     â”‚
â”‚  ã€ãƒ•ãƒ­ãƒ¼3ã€‘                                        â”‚
â”‚  [LLMå‘¼ã³å‡ºã—]                                      â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼ post_processï¼ˆçµæœã‚’é›†ç´„ï¼‰

å¤–éƒ¨ OUT: {
  flow1: { ... },
  flow2: { ... },
  flow3: { ... }
}
```

**è¨­å®š**:
```typescript
interface ParallelConfig {
  maxConcurrent?: number  // æœ€å¤§åŒæ™‚å®Ÿè¡Œæ•°ï¼ˆ0 = ç„¡åˆ¶é™ï¼‰
  failFast?: boolean      // æœ€åˆã®ã‚¨ãƒ©ãƒ¼ã§å…¨åœæ­¢
}
```

**ä¸¦åˆ—å˜ä½ã®åˆ¤å®š**: ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®ã€Œé€£çµæˆåˆ†ã€ï¼ˆç¹‹ãŒã£ã¦ã„ãªã„ãƒ•ãƒ­ãƒ¼ï¼‰ã‚’è‡ªå‹•åˆ¤å®š

**å‡ºåŠ›ãƒãƒ¼ãƒˆ**:
- `out`: ã™ã¹ã¦ã®ãƒ•ãƒ­ãƒ¼ãŒæˆåŠŸã—ãŸå ´åˆ
- `error`: ã„ãšã‚Œã‹ã®ãƒ•ãƒ­ãƒ¼ãŒå¤±æ•—ã—ãŸå ´åˆï¼ˆfailFastæ™‚ï¼‰

---

### 2. Try-Catchï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼‰

**ç”¨é€”**: ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã« error ãƒãƒ¼ãƒˆã¸åˆ†å²

```
å¤–éƒ¨ IN: { data: ... }
    â”‚
    â–¼ pre_process

â”Œâ”€ Try-Catch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                      â”‚
â”‚  [APIå‘¼ã³å‡ºã—] â”€â”€> [ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼] â”€â”€> [ä¿å­˜]          â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                              â”‚
    â–¼ post_process (æˆåŠŸæ™‚)        â–¼ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚

å¤–éƒ¨ OUT (success)              å¤–éƒ¨ OUT (error)
{ result: ... }                 { error: "...", input: {...} }
    â”‚                              â”‚
    â–¼                              â–¼
[æ¬¡ã®å‡¦ç†]                     [ã‚¨ãƒ©ãƒ¼å‡¦ç†ãƒ–ãƒ­ãƒƒã‚¯]
```

**è¨­å®š**:
```typescript
interface TryCatchConfig {
  retryCount?: number   // ãƒªãƒˆãƒ©ã‚¤å›æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 0ï¼‰
  retryDelay?: number   // ãƒªãƒˆãƒ©ã‚¤é–“éš”ï¼ˆmsï¼‰
}
```

**å‡ºåŠ›ãƒãƒ¼ãƒˆ**:
- `out`: æ­£å¸¸å®Œäº†
- `error`: ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿï¼ˆã‚¨ãƒ©ãƒ¼æƒ…å ± + å…ƒã®å…¥åŠ›ã‚’å‡ºåŠ›ï¼‰

**é‡è¦ãªå¤‰æ›´ç‚¹**:
- catch ãƒ­ãƒ¼ãƒ«ã‚’å»ƒæ­¢
- ã‚¨ãƒ©ãƒ¼å‡¦ç†ã¯å¤–éƒ¨ãƒ–ãƒ­ãƒƒã‚¯ã§è¡Œã†
- ã‚°ãƒ«ãƒ¼ãƒ—ã¯ body ã®ã¿

---

### 3. ForEachï¼ˆé…åˆ—åå¾©ï¼‰

**ç”¨é€”**: é…åˆ—ã®å„è¦ç´ ã«åŒã˜å‡¦ç†ã‚’é©ç”¨

```
å¤–éƒ¨ IN: { items: [A, B, C], context: {...} }
    â”‚
    â–¼ pre_processï¼ˆé…åˆ—ã‚’å±•é–‹ï¼‰

â”Œâ”€ ForEach â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                      â”‚
â”‚  iteration 0: { item: A, index: 0, context: {...} } â”‚
â”‚  iteration 1: { item: B, index: 1, context: {...} } â”‚
â”‚  iteration 2: { item: C, index: 2, context: {...} } â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  [å‡¦ç†ãƒ–ãƒ­ãƒƒã‚¯] â”€â”€> [å¤‰æ›ãƒ–ãƒ­ãƒƒã‚¯]            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼ post_processï¼ˆçµæœã‚’é…åˆ—ã«é›†ç´„ï¼‰

å¤–éƒ¨ OUT: {
  results: [A', B', C'],
  _meta: { iterations: 3, ... }
}
```

**è¨­å®š**:
```typescript
interface ForEachConfig {
  inputPath?: string    // é…åˆ—ãƒ‘ã‚¹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: "$.items"ï¼‰
  parallel?: boolean    // ä¸¦åˆ—å®Ÿè¡Œã™ã‚‹ã‹
  maxWorkers?: number   // æœ€å¤§ãƒ¯ãƒ¼ã‚«ãƒ¼æ•°
}
```

**å‡ºåŠ›ãƒãƒ¼ãƒˆ**:
- `out`: ã™ã¹ã¦ã®åå¾©ãŒæˆåŠŸ
- `error`: ã„ãšã‚Œã‹ã®åå¾©ãŒå¤±æ•—

**pre_process ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œ**:
```javascript
// å¤–éƒ¨ IN ã‹ã‚‰é…åˆ—ã‚’å–å¾—ã—ã€å„è¦ç´ ã‚’å†…éƒ¨ IN ã«å¤‰æ›
const items = getPath(input, config.inputPath || '$.items');
return items.map((item, index) => ({
  item,
  index,
  context: input.context || {}
}));
```

**post_process ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œ**:
```javascript
// å„åå¾©ã®çµæœã‚’é…åˆ—ã«é›†ç´„
return {
  results: outputs,
  _meta: {
    iterations: outputs.length,
    completedAt: new Date().toISOString()
  }
};
```

---

### 4. Whileï¼ˆæ¡ä»¶ãƒ«ãƒ¼ãƒ—ï¼‰

**ç”¨é€”**: æ¡ä»¶ãŒæº€ãŸã•ã‚Œã‚‹é–“ã€å‡¦ç†ã‚’ç¹°ã‚Šè¿”ã™

```
å¤–éƒ¨ IN: { counter: 0, target: 5, data: [] }
    â”‚
    â–¼ pre_process

â”Œâ”€ While â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  condition: "$.counter < $.target"                   â”‚
â”‚                                                      â”‚
â”‚  iteration 0: { counter: 0, ... }                   â”‚
â”‚  iteration 1: { counter: 1, ... }                   â”‚
â”‚  iteration 2: { counter: 2, ... }                   â”‚
â”‚  ...                                                 â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  [å‡¦ç†] â”€â”€> [ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ›´æ–°]                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼ post_process

å¤–éƒ¨ OUT: {
  result: { counter: 5, data: [...] },
  _meta: { iterations: 5, ... }
}
```

**è¨­å®š**:
```typescript
interface WhileConfig {
  condition: string       // æ¡ä»¶å¼ï¼ˆä¾‹: "$.counter < $.target"ï¼‰
  maxIterations?: number  // å®‰å…¨åˆ¶é™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 100ï¼‰
  doWhile?: boolean       // do-whileå½¢å¼ï¼ˆå…ˆã«å®Ÿè¡Œã€å¾Œã§åˆ¤å®šï¼‰
}
```

**å‡ºåŠ›ãƒãƒ¼ãƒˆ**:
- `out`: æ¡ä»¶ãŒ false ã«ãªã‚Šãƒ«ãƒ¼ãƒ—çµ‚äº†
- `error`: maxIterations åˆ°é” ã¾ãŸã¯ body å†…ã§ã‚¨ãƒ©ãƒ¼

**ãƒ«ãƒ¼ãƒ—ã®å‹•ä½œ**:
1. æ¡ä»¶ã‚’è©•ä¾¡
2. true ã®å ´åˆã€body ã‚’å®Ÿè¡Œ
3. body ã®å‡ºåŠ›ã‚’æ¬¡ã®åå¾©ã®å…¥åŠ›ã¨ã—ã¦ä½¿ç”¨
4. 1 ã«æˆ»ã‚‹

---

## ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

### BlockGroup ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£

```go
type BlockGroup struct {
    ID        uuid.UUID `json:"id"`
    TenantID  uuid.UUID `json:"tenantId"`
    WorkflowID uuid.UUID `json:"workflowId"`

    // åŸºæœ¬æƒ…å ±
    Name        string         `json:"name"`
    Type        BlockGroupType `json:"type"`  // parallel, try_catch, foreach, while
    Description string         `json:"description"`

    // å…¥å‡ºåŠ›å¤‰æ›ï¼ˆé€šå¸¸ãƒ–ãƒ­ãƒƒã‚¯ã¨åŒã˜ä»•çµ„ã¿ï¼‰
    PreProcess  *string `json:"preProcess"`   // JS: å¤–éƒ¨IN â†’ å†…éƒ¨IN
    PostProcess *string `json:"postProcess"`  // JS: å†…éƒ¨OUT â†’ å¤–éƒ¨OUT

    // ã‚°ãƒ«ãƒ¼ãƒ—å›ºæœ‰è¨­å®š
    Config json.RawMessage `json:"config"`

    // ãƒã‚¹ãƒˆå¯¾å¿œ
    ParentGroupID *uuid.UUID `json:"parentGroupId"`

    // ä½ç½®ãƒ»ã‚µã‚¤ã‚ºï¼ˆUIç”¨ï¼‰
    PositionX int `json:"positionX"`
    PositionY int `json:"positionY"`
    Width     int `json:"width"`
    Height    int `json:"height"`

    // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
    CreatedAt time.Time `json:"createdAt"`
    UpdatedAt time.Time `json:"updatedAt"`
}

// ã‚°ãƒ«ãƒ¼ãƒ—ã‚¿ã‚¤ãƒ—ï¼ˆ4ç¨®é¡ã®ã¿ï¼‰
const (
    BlockGroupTypeParallel = "parallel"
    BlockGroupTypeTryCatch = "try_catch"
    BlockGroupTypeForEach  = "foreach"
    BlockGroupTypeWhile    = "while"
)
```

### è¨­å®šæ§‹é€ ä½“

```go
// ParallelConfig ä¸¦åˆ—å®Ÿè¡Œè¨­å®š
type ParallelConfig struct {
    MaxConcurrent int  `json:"maxConcurrent"` // 0 = ç„¡åˆ¶é™
    FailFast      bool `json:"failFast"`
}

// TryCatchConfig ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¨­å®š
type TryCatchConfig struct {
    RetryCount int `json:"retryCount"`
    RetryDelay int `json:"retryDelay"` // ms
}

// ForEachConfig é…åˆ—åå¾©è¨­å®š
type ForEachConfig struct {
    InputPath  string `json:"inputPath"`  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: "$.items"
    Parallel   bool   `json:"parallel"`
    MaxWorkers int    `json:"maxWorkers"`
}

// WhileConfig æ¡ä»¶ãƒ«ãƒ¼ãƒ—è¨­å®š
type WhileConfig struct {
    Condition     string `json:"condition"`
    MaxIterations int    `json:"maxIterations"` // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 100
    DoWhile       bool   `json:"doWhile"`
}
```

---

## å‡ºåŠ›ãƒãƒ¼ãƒˆå®šç¾©

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è¨­å®š

```typescript
const groupOutputPorts: Record<BlockGroupType, OutputPort[]> = {
  parallel: [
    { name: 'out', label: 'Complete', color: '#22c55e' },
    { name: 'error', label: 'Error', color: '#ef4444' },
  ],
  try_catch: [
    { name: 'out', label: 'Success', color: '#22c55e' },
    { name: 'error', label: 'Error', color: '#ef4444' },
  ],
  foreach: [
    { name: 'out', label: 'Complete', color: '#22c55e' },
    { name: 'error', label: 'Error', color: '#ef4444' },
  ],
  while: [
    { name: 'out', label: 'Done', color: '#22c55e' },
    { name: 'error', label: 'Error', color: '#ef4444' },
  ],
}
```

---

## å®Ÿè¡Œã‚¨ãƒ³ã‚¸ãƒ³ã®å¤‰æ›´

### Parallel å®Ÿè¡Œ

```go
func (e *BlockGroupExecutor) executeParallel(ctx context.Context, group *BlockGroup, input json.RawMessage) (*BlockGroupResult, error) {
    config := parseParallelConfig(group.Config)

    // 1. pre_process ã§å…¥åŠ›ã‚’å¤‰æ›
    internalInput, err := e.runPreProcess(ctx, group, input)
    if err != nil {
        return nil, err
    }

    // 2. body å†…ã®é€£çµæˆåˆ†ï¼ˆç‹¬ç«‹ã—ãŸãƒ•ãƒ­ãƒ¼ï¼‰ã‚’æ¤œå‡º
    flows := e.detectFlows(group.ID)

    // 3. ã‚»ãƒãƒ•ã‚©ã§ä¸¦åˆ—æ•°ã‚’åˆ¶å¾¡
    sem := make(chan struct{}, config.MaxConcurrent)
    if config.MaxConcurrent == 0 {
        sem = make(chan struct{}, len(flows))
    }

    // 4. å„ãƒ•ãƒ­ãƒ¼ã‚’ä¸¦åˆ—å®Ÿè¡Œ
    var wg sync.WaitGroup
    results := make(map[string]json.RawMessage)
    var firstError error
    var mu sync.Mutex

    for _, flow := range flows {
        wg.Add(1)
        go func(f *Flow) {
            defer wg.Done()
            sem <- struct{}{}
            defer func() { <-sem }()

            result, err := e.executeFlow(ctx, f, internalInput)
            mu.Lock()
            defer mu.Unlock()

            if err != nil {
                if firstError == nil {
                    firstError = err
                }
                if config.FailFast {
                    return
                }
            }
            results[f.Name] = result
        }(flow)
    }

    wg.Wait()

    // 5. post_process ã§å‡ºåŠ›ã‚’å¤‰æ›
    internalOutput, _ := json.Marshal(results)
    output, err := e.runPostProcess(ctx, group, internalOutput)

    if firstError != nil && config.FailFast {
        return &BlockGroupResult{
            Output: output,
            Port:   "error",
            Error:  firstError,
        }, nil
    }

    return &BlockGroupResult{
        Output: output,
        Port:   "out",
    }, nil
}
```

### Try-Catch å®Ÿè¡Œ

```go
func (e *BlockGroupExecutor) executeTryCatch(ctx context.Context, group *BlockGroup, input json.RawMessage) (*BlockGroupResult, error) {
    config := parseTryCatchConfig(group.Config)

    // 1. pre_process ã§å…¥åŠ›ã‚’å¤‰æ›
    internalInput, err := e.runPreProcess(ctx, group, input)
    if err != nil {
        return nil, err
    }

    // 2. body ã‚’å®Ÿè¡Œï¼ˆãƒªãƒˆãƒ©ã‚¤ä»˜ãï¼‰
    var lastError error
    for attempt := 0; attempt <= config.RetryCount; attempt++ {
        if attempt > 0 {
            time.Sleep(time.Duration(config.RetryDelay) * time.Millisecond)
        }

        result, err := e.executeBody(ctx, group, internalInput)
        if err == nil {
            // 3. æˆåŠŸæ™‚: post_process ã§å‡ºåŠ›ã‚’å¤‰æ›
            output, _ := e.runPostProcess(ctx, group, result)
            return &BlockGroupResult{
                Output: output,
                Port:   "out",
            }, nil
        }
        lastError = err
    }

    // 4. å¤±æ•—æ™‚: ã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’å‡ºåŠ›
    errorOutput, _ := json.Marshal(map[string]any{
        "error": lastError.Error(),
        "input": json.RawMessage(input),
    })

    return &BlockGroupResult{
        Output: errorOutput,
        Port:   "error",
        Error:  lastError,
    }, nil
}
```

---

## ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç”»

### Phase 1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¤‰æ›´

```sql
-- 1. block_groups ãƒ†ãƒ¼ãƒ–ãƒ«ã« pre_process, post_process ã‚«ãƒ©ãƒ è¿½åŠ 
ALTER TABLE block_groups
ADD COLUMN pre_process TEXT,
ADD COLUMN post_process TEXT;

-- 2. group_role ã‚«ãƒ©ãƒ ã‚’ steps ã‹ã‚‰å‰Šé™¤ï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¾Œï¼‰
-- ALTER TABLE steps DROP COLUMN group_role;
```

### Phase 2: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å¤‰æ›´

1. `domain/block_group.go` - æ–°ã—ã„æ§‹é€ ä½“å®šç¾©
2. `engine/block_group_executor.go` - æ–°ã—ã„å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯
3. å»ƒæ­¢ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆif_else, switch_caseï¼‰ã®å‰Šé™¤
4. loop ã‚·ã‚¹ãƒ†ãƒ ãƒ–ãƒ­ãƒƒã‚¯ã®å‰Šé™¤

### Phase 3: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å¤‰æ›´

1. `composables/useBlockGroups.ts` - APIæ›´æ–°
2. `components/dag-editor/DagEditor.vue` - ã‚¾ãƒ¼ãƒ³åˆ†å‰²UIã®å‰Šé™¤
3. ã‚°ãƒ«ãƒ¼ãƒ—ã® pre_process / post_process ç·¨é›†UIè¿½åŠ 

### Phase 4: ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

1. æ—¢å­˜ã® if_else ã‚°ãƒ«ãƒ¼ãƒ— â†’ condition ãƒ–ãƒ­ãƒƒã‚¯ã«å¤‰æ›
2. æ—¢å­˜ã® switch_case ã‚°ãƒ«ãƒ¼ãƒ— â†’ switch ãƒ–ãƒ­ãƒƒã‚¯ã«å¤‰æ›
3. æ—¢å­˜ã® loop ãƒ–ãƒ­ãƒƒã‚¯ â†’ while ã‚°ãƒ«ãƒ¼ãƒ—ã«å¤‰æ›
4. try/catch/then/else ãƒ­ãƒ¼ãƒ«ã®ã‚¹ãƒ†ãƒƒãƒ— â†’ å¤–éƒ¨ãƒ–ãƒ­ãƒƒã‚¯ã«ç§»å‹•

---

## ç§»è¡Œã‚¬ã‚¤ãƒ‰

### if_else ã‚°ãƒ«ãƒ¼ãƒ— â†’ condition ãƒ–ãƒ­ãƒƒã‚¯

```
ã€Beforeã€‘
â”Œâ”€ If-Else â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  condition: "$.status == 'active'"         â”‚
â”‚  â”Œâ”€ THEN â”€â”€â”€â”€â”€â”  â”Œâ”€ ELSE â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ [å‡¦ç†A]     â”‚  â”‚ [å‡¦ç†B]     â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€Afterã€‘
                  â”Œâ”€â”€> [å‡¦ç†A] â”€â”€> ...
[condition] â”€â”€â”€â”€â”€â”¤
  $.status ==    â””â”€â”€> [å‡¦ç†B] â”€â”€> ...
  'active'
```

### try_catch ã‚°ãƒ«ãƒ¼ãƒ— â†’ æ–° try_catch ã‚°ãƒ«ãƒ¼ãƒ— + å¤–éƒ¨ãƒ–ãƒ­ãƒƒã‚¯

```
ã€Beforeã€‘
â”Œâ”€ Try-Catch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€ TRY â”€â”€â”€â”€â”€â”€â”  â”Œâ”€ CATCH â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ [APIå‘¼å‡º]   â”‚  â”‚ [ã‚¨ãƒ©ãƒ¼å‡¦ç†] â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€Afterã€‘
â”Œâ”€ Try-Catch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [APIå‘¼å‡º]                  â”‚â”€â”€> (out) â”€â”€> [æ¬¡ã®å‡¦ç†]
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â””â”€â”€> (error) â”€â”€> [ã‚¨ãƒ©ãƒ¼å‡¦ç†]
```

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [UNIFIED_BLOCK_MODEL.md](./UNIFIED_BLOCK_MODEL.md) - çµ±ä¸€ãƒ–ãƒ­ãƒƒã‚¯ãƒ¢ãƒ‡ãƒ«
- [BLOCK_REGISTRY.md](../BLOCK_REGISTRY.md) - ãƒ–ãƒ­ãƒƒã‚¯å®šç¾©ä¸€è¦§
- [BACKEND.md](../BACKEND.md) - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³
