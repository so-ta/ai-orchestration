# Notion API基盤ブロック
---
slug: notion-api
version: 2
name: Notion API
description: Notion API基盤ブロック
category: apps
subcategory: notion
icon: file-text
parent_block_slug: bearer-api
enabled: true

config_defaults:
  base_url: https://api.notion.com/v1
  secret_key: NOTION_API_KEY

config_schema:
  type: object
  properties:
    api_key:
      type: string
      title: API Key
      x-ui-widget: secret-key

pre_process: |
  // api_key -> auth_key にマッピング（親のbearer-api用）
  if (config.api_key && !config.auth_key) {
      config.auth_key = config.api_key;
  }
  return {
      ...input,
      headers: {
          ...(input.headers || {}),
          'Notion-Version': '2022-06-28'
      }
  };

ui_config:
  icon: file-text
  color: "#000000"

error_codes:
  - code: NOTION_001
    name: API_KEY_NOT_CONFIGURED
    description: API Keyが設定されていません
    retryable: false

# Notion DB検索ブロック - omit_emptyを使用した宣言的設定
---
slug: notion_query_db
version: 3
name: "Notion: DB検索"
description: Notionデータベースを検索
category: apps
subcategory: notion
icon: database
parent_block_slug: notion-api
enabled: true

config_schema:
  type: object
  required: [database_id]
  properties:
    database_id:
      type: string
      title: データベースID
    filter:
      type: object
      title: フィルター
      x-ui-widget: output-schema
    sorts:
      type: array
      title: ソート
      x-ui-widget: output-schema
    page_size:
      type: number
      title: 取得件数
      default: 100
      minimum: 1
      maximum: 100
    api_key:
      type: string
      title: API Key

output_schema:
  type: object
  properties:
    results:
      type: array
    has_more:
      type: boolean
    next_cursor:
      type: string

# 宣言的設定 - omit_emptyでオプショナルフィールドを処理
request:
  url: "/databases/{{database_id}}/query"
  method: POST
  body:
    filter:
      value: "{{filter}}"
      omit_empty: true
    sorts:
      value: "{{sorts}}"
      omit_empty: true
    page_size: "{{page_size}}"

response:
  success_status: [200]
  error_mapping:
    - condition: status >= 400
      code: NOTION_004
      message: "クエリ失敗: {{body.message}}"
  output_mapping:
    results: body.results
    has_more: body.has_more
    next_cursor: body.next_cursor

ui_config:
  icon: database
  color: "#000000"

error_codes:
  - code: NOTION_001
    name: API_KEY_NOT_CONFIGURED
    description: API Keyが設定されていません
    retryable: false
  - code: NOTION_004
    name: QUERY_FAILED
    description: クエリに失敗しました
    retryable: true
